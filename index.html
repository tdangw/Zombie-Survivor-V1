<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zombie Survivor - Dang</title>
<style>
  :root {
  /* ğŸ¨ MÃ u sáº¯c chÃ­nh */
  --color-bg-dark: #111;
  --color-primary: #00ffff;
  --color-accent: gold;
  --color-danger: #ff4c4c;
  --color-text: #e0f7fa;
  --color-hover-bg: #22404c;
  --color-hover-border: #3d6c78;
  --color-title: #aefeff;
  --glow-title: 0 0 6px #7f7fff, 0 0 12px #4d4dfb;

  /* ğŸ”˜ MÃ u button riÃªng */
  --btn-bg: #1a2b33;
  --btn-border: #294e5a;

  /* ğŸ”¤ KÃ­ch thÆ°á»›c font chá»¯ */
  --font-xs: 0.75rem;
  --font-sm: 0.9rem;
  --font-md: 1rem;
  --font-lg: 1.25rem;
  --font-xl: 1.5rem;
  --font-xxl: 2.5rem;

  /* ğŸ“ KÃ­ch thÆ°á»›c padding/margin chuáº©n */
  --space-xs: 0.4rem;
  --space-sm: 0.6rem;
  --space-md: 1rem;
  --space-lg: 1.5rem;
  --space-xl: 2rem;

  /* ğŸŒŸ Äá»™ sÃ¡ng bÃ³ng / hiá»‡u á»©ng */
  --glow-primary: 0 0 8px var(--color-primary);
  --glow-accent: 0 0 8px var(--color-accent);
}

  body { margin: 0; background: #111; overflow: hidden; font-family: sans-serif; }
  canvas { display: block; margin: auto; background: radial-gradient(#333, #000); transition: background 1s ease; }
/* ğŸ¯ Giao diá»‡n chÃ­nh */
#ui {
  position: absolute;
  top: 0vh; /* cÃ¡ch top theo chiá»u cao mÃ n hÃ¬nh */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.2rem; /* khoáº£ng cÃ¡ch giá»¯a cÃ¡c nÃºt */
  padding: 0.7rem 1.5rem; 
  background: rgb(0, 0, 0); /* ná»n trong suá»‘t */
  border-radius: 0rem;
  width: 90%; /* tá»· lá»‡ theo chiá»u ngang */
  max-width: 57rem; /* giá»›i háº¡n tá»‘i Ä‘a */
  justify-content: center;
  z-index: 1000;
  flex-wrap: wrap;
}

/* ğŸ”˜ NÃºt trong UI (nhá» gá»n hÆ¡n nÃºt máº·c Ä‘á»‹nh) */
#ui button {
  padding: 0.6rem 0.6rem;
  font-size: 0.75rem;
  min-width: 6.5rem;
}

/* ğŸ”˜ NÃºt máº·c Ä‘á»‹nh cho toÃ n giao diá»‡n */
button {
  font-family: 'Segoe UI', sans-serif;
  padding: 0.65rem 1.25rem;
  font-size: 1rem;
  cursor: pointer;
  min-width: 6.5rem;
  text-align: center;
  background-color: #1a2b33;
  border: 0.125rem solid #294e5a;
  border-radius: 0.5rem;
  color: #e0f7fa;
  transition: all 0.2s ease;
  box-shadow: 0 0.125rem 0.3rem rgba(0, 0, 0, 0.2);
}

/* ğŸ” Hiá»‡u á»©ng hover cho nÃºt */
button:hover {
  background-color: #22404c;
  border-color: #3d6c78;
  color: #ffffff;
  transform: translateY(-0.06rem);
}

/* ğŸ–± Hiá»‡u á»©ng khi click giá»¯ */
button:active {
  transform: scale(0.97);
  box-shadow: 0 0.06rem 0.2rem rgba(0, 0, 0, 0.3);
}

/* âœ³ï¸ NÃºt Ä‘ang active (Ä‘Æ°á»£c chá»n) */
button.active {
  border-color: #00ffff;
  box-shadow: 0 0 0.625rem #00ffffaa;
}

/* âœ… Tráº¡ng thÃ¡i active dÃ¹ng cho nhiá»u thÃ nh pháº§n */
.active {
  outline: 0.125rem solid gold;
  border-radius: 0.5rem;
}

/* ğŸ“Š VÃ¹ng hiá»ƒn thá»‹ Ä‘iá»ƒm sá»‘ hoáº·c thÃ´ng tin */
#score {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-width: 7.5rem;
  text-align: center;
  color: white;
  font-size: 1rem;
  padding: 0.3rem 0.6rem;
}

/* â„¹ï¸ Tooltip container bao ngoÃ i Ä‘á»ƒ hiá»ƒn thá»‹ gá»£i Ã½ */
.tooltip-container {
  position: relative;
  display: inline-block;
  margin: 0.4rem;
}

/* ğŸ“ Tooltip ná»™i dung khi hover */
.tooltip-container .tooltip-text {
  visibility: hidden;
  background-color: #222;
  color: #fff;
  text-align: left;
  border-radius: 0.375rem;
  padding: 0.5rem 0.6rem;
  position: absolute;
  z-index: 10;
  top: 110%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  width: 13.75rem;
  font-size: 0.8125rem;
  line-height: 1.5;
  white-space: pre-line;
  transition: opacity 0.3s ease;
  box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.5);
}

/* ğŸ–± Hiá»ƒn thá»‹ tooltip khi hover vÃ o container */
.tooltip-container:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

/* ğŸ”„ NÃºt restart Ä‘áº·c biá»‡t */
#restartBtn {
  padding: 0.75rem 1.75rem;
  font-weight: bold;
  background-color: #1c2e36;
  border: 0.125rem solid #3a6b75;
  border-radius: 0.5rem;
  font-size: 1rem;
  color: #aefeff;
  cursor: pointer;
  transition: 0.25s ease;
}

/* ğŸ–± Hover cho restart */
#restartBtn:hover {
  background-color: #28515f;
  color: white;
  transform: translateY(-0.06rem);
}

/* â³ Hiá»ƒn thá»‹ Ä‘á»“ng há»“ Ä‘áº¿m wave */
#waveTimerDisplay {
  position: fixed;
  top: 12vh;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.2rem;
  color: gold;
  z-index: 10;
  text-shadow: 0 0 8px gold;
  font-weight: bold;
  font-family: 'Courier New', monospace;
  letter-spacing: 0.1rem;
  pointer-events: none;
}

/* ğŸŒŠ Popup khi báº¯t Ä‘áº§u Wave */
#wavePopup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(1);
  font-size: 2.5rem;
  color: var(--color-primary);
  font-weight: bold;
  text-shadow:
    0 0 8px var(--color-accent),
    0 0 20px var(--color-accent);
  display: none;
  z-index: 999;
  opacity: 0;
  animation: waveFade 1s ease-out forwards;
}

/* âœ¨ Animation xuáº¥t hiá»‡n má»m mÆ°á»£t */
@keyframes waveFade {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.7);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.05);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* ğŸ“‹ Menu báº¯t Ä‘áº§u game */
#startMenu {
  max-width: 24rem;
  width: 90%;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  padding: 2rem;
  text-align: center;
  border-radius: 1rem;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 9999;
}

/* ğŸŒŸ Popup khi lÃªn cáº¥p */
#levelUpPopup {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.5rem;
  color: gold;
  font-weight: bold;
  text-shadow: 0 0 15px #ffff00;
  display: none;
  z-index: 2000;
}

/* ğŸ’€ Panel Game Over hiá»ƒn thá»‹ khi thua */
.gameOverPanel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #22222200;
  padding: 30px;
  color: white;
  display: none;
  flex-direction: column;
  align-items: center;
  border-radius: 10px;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 2000;
}

/* ğŸ¯ TiÃªu Ä‘á» Game Over */
.gameOverTitle {
  color: #ff5722;
  font-size: 2.5rem;
  text-shadow: 0 0 4px #ffff00, 0 0 4px #ffff00;
  margin-bottom: 1rem;
}

/* ğŸ” NÃºt ChÆ¡i láº¡i trong Game Over Panel */
.restartButton {
  margin-top: 10px;
  padding: 10px 20px;
  background-color: #1c2e36;
  border: 0.125rem solid #3a6b75;
  border-radius: 0.5rem;
  font-size: 1rem;
  color: #aefeff;
  cursor: pointer;
  transition: 0.25s ease;
}

.restartButton:hover {
  background-color: #28515f;
  color: white;
  transform: translateY(-0.06rem);
}

/* ğŸ§  TiÃªu Ä‘á» game á»Ÿ menu báº¯t Ä‘áº§u */
.gameTitle {
  font-size: 2.5rem;
  font-weight: 900;
  color: var(--color-title);
  text-shadow: var(--glow-title);
  margin-bottom: 1.5rem;
  font-family: 'Segoe UI', sans-serif;
}

/* âš ï¸ Popup cáº£nh bÃ¡o (dÃ¹ng cho showWarning) */
.warningPopup {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 32, 64, 0.9);
  color: var(--color-text);
  padding: var(--space-sm) var(--space-lg);
  border-radius: 0.75rem;
  font-size: var(--font-md);
  font-weight: 500;
  z-index: 9999;
  box-shadow: 0 0 10px #00bcd4aa;
  font-family: 'Segoe UI', sans-serif;
  pointer-events: none;
}

/* ğŸŒŸ Giao diá»‡n popup nÃ¢ng cáº¥p */
#upgradePopup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.85);
  border: 2px solid gold;
  padding: 2rem;
  border-radius: 1rem;
  z-index: 9999;
  max-width: 36rem;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px gold;
}

.upgradeTitle {
  color: gold;
  font-size: 1.8rem;
  font-weight: bold;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 6px gold;
  margin-top: 1rem;
}

.upgradeChoices {
  display: flex;
  justify-content: center;
  gap: 1rem;
  flex-wrap: nowrap; /* â— KHÃ”NG cho xuá»‘ng dÃ²ng */
}

.upgradeChoices button {
  padding: 0.8rem 1.2rem;
  border: 2px solid #ccc;
  border-radius: 0.6rem;
  background: #111;
  color: white;
  font-size: 1rem;
  font-weight: bold;
  min-width: 8rem;
  cursor: pointer;
  transition: 0.2s ease;
}

.upgradeChoices button:hover {
  background: #22404c;
  border-color: gold;
  color: #fff;
  box-shadow: 0 0 10px gold;
}

/* ğŸ“Š Overlay thá»‘ng kÃª */
#statsOverlay {
  position: fixed;
  top: 0.5rem;
  right: 0.5rem;
  background: rgba(0, 0, 0, 0.7);
  border: 2px solid #00ffff;
  border-radius: 1rem;
  padding: 1rem;
  color: #e0f7fa;
  font-size: 0.95rem;
  line-height: 1.5;
  z-index: 9999;
  width: 15rem;
  font-family: 'Segoe UI', sans-serif;
}

#statsOverlay h3 {
  font-size: 1.1rem;
  margin-top: 0;
  margin-bottom: 0.5rem;
  color: gold;
  text-align: center;
}

#statsOverlay.hidden {
  display: none;
}
/* káº¿t thÃºc style */
</style>
</head>
<body>
<div id="ui">
<div class="tooltip-container">
  <button id="autoBtn">âš™ï¸ Auto</button>
  <span class="tooltip-text">âš™ï¸ Auto:
    - Tá»± Ä‘á»™ng táº¥n cÃ´ng zombie gáº§n nháº¥t
    - TiÃªu hao: 0 âš¡
  </span>
</div>

<div class="tooltip-container">
  <button id="bladeBtn">ğŸ”ª Äao</button>
  <span class="tooltip-text">ğŸ”ª Ká»¹ nÄƒng Äao:
    - Táº¡o 20 thanh Ä‘ao xoay quanh
    - Bay vÃ o zombie gáº§n nháº¥t
    - YÃªu cáº§u level 1
    - SÃ¡t thÆ°Æ¡ng: 1 
    - Hiá»‡u lá»±c: 30s â±
    - TiÃªu hao: 3 âš¡
  </span>
</div>

<div class="tooltip-container">
  <button id="swordBtn">âš”ï¸ Kiáº¿m</button>
  <span class="tooltip-text">âš”ï¸ Ká»¹ nÄƒng Kiáº¿m:
    - Táº¡o mÆ°a kiáº¿m rÆ¡i tá»«ng Ä‘á»£t
    - Bay vÃ o zombie gáº§n nháº¥t
    - YÃªu cáº§u level 3
    - SÃ¡t thÆ°Æ¡ng: 1
    - Hiá»‡u lá»±c: 30s â±
    - TiÃªu hao: 6 âš¡
  </span>
</div>

<div class="tooltip-container">
  <button id="fireBtn">ğŸ”¥ Lá»­a</button>
  <span class="tooltip-text">ğŸ”¥ Ká»¹ nÄƒng Lá»­a:
    - Táº¡o 2 quáº£ cáº§u lá»­a quay quanh
    - TiÃªu diá»‡t zombie cháº¡m vÃ o
    - YÃªu cáº§u level 5
    - SÃ¡t thÆ°Æ¡ng: 1
    - Hiá»‡u lá»±c: 45s â±
    - TiÃªu hao: 8 âš¡
  </span>
</div>

<div class="tooltip-container">
  <button id="iceBtn">â„ï¸ BÄƒng</button>
  <span class="tooltip-text">â„ï¸ Ká»¹ nÄƒng BÄƒng (má»Ÿ khÃ³a Lv10):
    - Táº¡o 4 quáº£ cáº§u bÄƒng lá»›n xoay quanh
    - GÃ¢y sÃ¡t thÆ°Æ¡ng diá»‡n rá»™ng
    - YÃªu cáº§u level 10
    - SÃ¡t thÆ°Æ¡ng: 1
    - Hiá»‡u lá»±c: 60s â±
    - TiÃªu hao: 12 âš¡
  </span>
</div>

<div id="score">
<div id="score-top">Äiá»ƒm: 0 | Ká»· lá»¥c: 0 | â¤ï¸: 3</div>
  <div id="score-bottom">Lv: 1 | âš¡: 0</div>
</div>  </div>
<canvas id="game" width="960" height="720"></canvas>

<!-- ğŸ“‹ Menu báº¯t Ä‘áº§u game -->
<div id="startMenu">
  <h2 class="gameTitle">Zombie Survivor</h2>
  <button onclick="startGame()">Báº¯t Ä‘áº§u</button>
</div>

<!-- ğŸ’€ Game Over Panel -->
<div id="gameOverPanel" class="gameOverPanel" style="display: none;">
  <h2 class="gameOverTitle">Game Over</h2>
  <button onclick="location.reload()" class="restartButton">ChÆ¡i láº¡i</button>
</div>

<!-- ğŸŒŠ Popup khi báº¯t Ä‘áº§u má»—i Wave -->
<div id="wavePopup">Wave 1</div>

<!-- â³ Äá»“ng há»“ Ä‘áº¿m thá»i gian wave -->
<div id="waveTimerDisplay">--:--:--</div>

<script>
// ğŸ§± 1. Biáº¿n toÃ n cá»¥c â€“ Cáº¥u hÃ¬nh & Khá»Ÿi táº¡o

// ğŸ”« Cáº¥u hÃ¬nh báº¯n
let shootCooldown = 1000;        // â± Delay giá»¯a má»—i Ä‘á»£t báº¯n
let lastShootBatchTime = 0;      // â± Má»‘c thá»i gian Ä‘á»£t báº¯n
let currentBurstShots = 0;       // ğŸ’¥ Sá»‘ viÃªn Ä‘Ã£ báº¯n trong Ä‘á»£t
let lastShootTime = 0;           // ğŸ•’ Thá»i Ä‘iá»ƒm báº¯n gáº§n nháº¥t
let autoBurstIndex = 0;
let autoLastBurstTime = 0;
const autoBurstDelay = 100; // ms delay giá»¯a tá»«ng viÃªn trong auto

// ğŸ§  Thá»‘ng kÃª â€“ Ká»¹ nÄƒng & zombie
let zombieKillCount = 0;
let zombieSpawnedCount = 0;
let zombieByLevel = {};
for (let i = 1; i <= 10; i++) zombieByLevel[i] = 0;
zombieByLevel.boss = 0;
zombieByLevel.miniBoss = 0;
let skillStats = {};             // ğŸ“Š Thá»‘ng kÃª ká»¹ nÄƒng

// ğŸ§ Tráº¡ng thÃ¡i ngÆ°á»i chÆ¡i
const player = {
  x: 400, y: 300, size: 20, speed: 1,
  hearts: 3, energy: 1, level: 1, score: 0,
  hitTimer: 0
};

// ğŸŒŸ Tráº¡ng thÃ¡i nÃ¢ng cáº¥p
const playerUpgrades = {
  fireRate: 1,          // ğŸ”« HÆ°á»›ng báº¯n
  damageBoost: 1,       // ğŸ’¥ SÃ¡t thÆ°Æ¡ng cá»™ng thÃªm
  hpBoost: 0,           // â¤ï¸ Sá»‘ láº§n Ä‘Ã£ tÄƒng mÃ¡u
  bulletSpeed: 1,       // ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n
  lineBulletCount: 1    // ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n
};

// âš™ï¸ Tráº¡ng thÃ¡i Ä‘iá»u khiá»ƒn & ká»¹ nÄƒng
let lastManualShootTime = 0;
const manualShootCooldown = 1000; // delay 1 giÃ¢y
let lastAutoShootTime = 0;
const autoShootCooldown = 1000;

let keys = {}, autoShoot = false;
let fireActive = false, iceActive = false;
let swordActive = false, bladeActive = false;
let frame = 0, gameOver = false;
let isPaused = false;
let pendingWave = null;

let nextFireIndex = 0; // Ká»¹ nÄƒng Ä‘ao xoay
// ğŸŒŠ Quáº£n lÃ½ wave
let wave = 1;
let waveTime = 300; // Thá»i gian má»—i wave
let waveTimer = waveTime;
let lastWaveTime = null;
let gameStarted = false;

// â± Thá»i gian ká»¹ nÄƒng
let fireTimer = 0, fireEndTime = 0;
let iceTimer = 0, iceEndTime = 0;
let swordTimer = 0, swordEndTime = 0;
let bladeTimer = 0, bladeEndTime = 0;
let levelUpGlowTime = 0;

// ğŸ“± Äiá»u khiá»ƒn cáº£m á»©ng
let touchStartX = null, touchStartY = null;
let touchMoveX = null, touchMoveY = null;

// ğŸ® Danh sÃ¡ch cÃ¡c Ä‘á»‘i tÆ°á»£ng trong game
let enemyBullets = []; // Zombie báº¯n tráº£
let zombies = [];
let bullets = [];
let swords = [];
let downwardSwords = [];
let fireballs = [];
let iceballs = [];
let items = [];
let explosions = [];

// ğŸ”§ Canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ğŸŒ€ Object Pooling
const bulletPool = [];
const explosionPool = [];
const zombiePool = [];
const swordPool = [];
const fireballPool = [];
const iceballPool = [];

//ğŸ“² 2. Sá»± kiá»‡n Ä‘iá»u khiá»ƒn bÃ n phÃ­m, chuá»™t, cáº£m á»©ng
// âŒ¨ï¸ BÃ n phÃ­m di chuyá»ƒn
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// ğŸ–± Click chuá»™t Ä‘á»ƒ báº¯n
canvas.addEventListener("click", () => {
  const now = Date.now();
  if (now - lastManualShootTime >= manualShootCooldown) {
    shoot();
    lastManualShootTime = now;
  }
});

document.addEventListener("keydown", e => {
  if (e.code === 'Space') shoot();
});

// ğŸ“± Äiá»u khiá»ƒn cáº£m á»©ng
canvas.addEventListener("touchstart", e => {
  const touch = e.touches[0];
  touchStartX = touch.clientX;
  touchStartY = touch.clientY;
});
canvas.addEventListener("touchmove", e => {
  const touch = e.touches[0];
  touchMoveX = touch.clientX;
  touchMoveY = touch.clientY;
  e.preventDefault(); // ngÄƒn cuá»™n trang
});
canvas.addEventListener("touchend", () => {
  touchStartX = null;
  touchStartY = null;
  touchMoveX = null;
  touchMoveY = null;
});

//ğŸ’¥ 3. HÃ m há»— trá»£ tiá»‡n Ã­ch
function distance(a, b) {
return Math.hypot(a.x - b.x, a.y - b.y);}

function dropItem(x, y, isBoss = false) {
  const dropRate = isBoss ? 0.3 : 0.05; // ğŸ§Ÿ Boss 30%, thÆ°á»ng 5% rÆ¡i váº­t pháº©m
  if (Math.random() < dropRate) {
    // ğŸ“¦ RÆ¡i lá»‡ch nháº¹ quanh vá»‹ trÃ­ zombie
    const offsetX = (Math.random() - 0.5) * 30;
    const offsetY = (Math.random() - 0.5) * 30;

    const safeX = Math.min(canvas.width - 20, Math.max(20, x + offsetX));
    const safeY = Math.min(canvas.height - 20, Math.max(20, y + offsetY));

    items.push({ x: safeX, y: safeY, active: true });
  }
}

// ğŸ” Bullet Pooling
function getBullet() {
  return bulletPool.length ? bulletPool.pop() : { x: 0, y: 0, dx: 0, dy: 0, active: true };
}
function releaseBullet(bullet) {
  bullet.active = false;
  bulletPool.push(bullet);
}

// ğŸ’¥ Explosion Pooling
function getExplosion(x, y) {
  const e = explosionPool.length ? explosionPool.pop() : { x: 0, y: 0, radius: 0, life: 0, active: true };
  e.x = x;
  e.y = y;
  e.radius = 0;
  e.life = 20;
  e.active = true;
  return e;
}
function releaseExplosion(e) {
  e.active = false;
  explosionPool.push(e);
}

// ğŸ§Ÿ Zombie Pooling
function getZombie() {
  let z = zombiePool.length ? zombiePool.pop() : {
    x: 0, y: 0, radius: 15, canHit: true, speed: 1,
    color: "hotpink", isBoss: false, hp: 1, active: true
  };

  z.active = true;
  z._killed = false; // âœ… reset láº¡i khi spawn
  return z;
}

function releaseZombie(z) {
  z.active = false;
  zombiePool.push(z);
}
// ğŸ’¥ HÃ m tiÃªu diá»‡t zombie, dÃ¹ng chung cho má»i ká»¹ nÄƒng
function killZombie(z) {
  if (z._killed || !z.active) return;
  z._killed = true;

  // ğŸ§Ÿ Gá»¡ khá»i mÃ n vÃ  cá»™ng thá»‘ng kÃª
  releaseZombie(z);
  zombieKillCount++;

  // ğŸ¯ Cá»™ng Ä‘iá»ƒm khi tiÃªu diá»‡t
  player.score++;

  // ğŸ“Š Äáº¿m theo cáº¥p (level 1-10)
  if (z.level && z.level >= 1 && z.level <= 10) {
    zombieByLevel[z.level] = (zombieByLevel[z.level] || 0) + 1;
  }

  // ğŸ’€ Äáº¿m miniBoss náº¿u lÃ  loáº¡i Ä‘Ã³
  if (z.type === "miniBoss") {
    zombieByLevel.miniBoss = (zombieByLevel.miniBoss || 0) + 1;
  }

  // ğŸ’€ Äáº¿m boss náº¿u lÃ  boss chÃ­nh
  if (z.isBoss) {
    zombieByLevel.boss = (zombieByLevel.boss || 0) + 1;
  }

  // ğŸ RÆ¡i váº­t pháº©m táº¡i vá»‹ trÃ­ zombie
  dropItem(z.x, z.y, z.isBoss);
}

// ğŸ”ª Sword Pooling
function getSword() {
  return swordPool.length ? swordPool.pop() : {
    angle: 0,
    radius: 60,
    state: 'charging',
    chargeFrame: 90,
    x: 0,
    y: 0,
    target: null,
    fireDelay: 0,
    delay: 60
  };
}

function releaseSword(s) {
  swordPool.push(s);
}

// ğŸ”¥ Fireball Pooling
function getFireball() {
  return fireballPool.length ? fireballPool.pop() : {
    angle: 0,
    radius: 40,
    x: 0,
    y: 0
  };
}

function releaseFireball(f) {
  fireballPool.push(f);
}

// â„ï¸ Iceball Pooling
function getIceball() {
  return iceballPool.length ? iceballPool.pop() : {
    angle: 0,
    radius: 60,
    x: 0,
    y: 0
  };
}

function releaseIceball(i) {
  iceballPool.push(i);
}

function showWarning(message) {
  const popup = document.createElement("div");
  popup.innerText = message;
  popup.className = "warningPopup";
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), 1000);
}

function generateGradient(index) {
  const hue1 = (index * 137) % 360;
  const hue2 = (hue1 + 60) % 360;
  return `radial-gradient(circle at center, hsl(${hue1}, 70%, 50%), hsl(${hue2}, 40%, 20%))`;}

//ğŸ”« 4. Báº¯n Ä‘áº¡n & auto shoot
function shoot() {
  const now = Date.now();
  if (now - lastManualShootTime < manualShootCooldown) return;
  lastManualShootTime = now;

  const directionCount = playerUpgrades.fireRate;
  const bulletsPerDirection = 1;
  const angleOffset = Math.random() * Math.PI * 2;
  const speed = playerUpgrades.bulletSpeed;

  for (let i = 0; i < directionCount; i++) {
    const angle = angleOffset + (2 * Math.PI / directionCount) * i;

    for (let j = 0; j < bulletsPerDirection; j++) {
      const b = getBullet();
      b.x = player.x;
      b.y = player.y;
      b.dx = Math.cos(angle);
      b.dy = Math.sin(angle);
      b.speed = speed;
      b.active = true;
      bullets.push(b);
    }
  }
}

function autoShootBurst() {
  const now = Date.now();
  if (now - lastAutoShootTime >= autoShootCooldown) {
    lastAutoShootTime = now;
    autoBurstIndex = 0;
  }

  const bulletsPerDirection = playerUpgrades.lineBulletCount;
  if (autoBurstIndex >= bulletsPerDirection) return;
  if (now - autoLastBurstTime < autoBurstDelay) return;
  if (zombies.length === 0) return;

  const target = zombies.reduce((a, b) =>
    distance(a, player) < distance(b, player) ? a : b
  );
  const angle = Math.atan2(target.y - player.y, target.x - player.x);

  const b = getBullet();
  b.x = player.x;
  b.y = player.y;
  b.dx = Math.cos(angle);
  b.dy = Math.sin(angle);
  b.speed = playerUpgrades.bulletSpeed;
  b.active = true;
  bullets.push(b);

  autoBurstIndex++;
  autoLastBurstTime = now;
}

//âš”ï¸ 5. KÃ­ch hoáº¡t ká»¹ nÄƒng (KÃ­ch hoáº¡t ká»¹ nÄƒng & gÃ¡n nÃºt)
function activateSwordSkill() {
  if (!swordActive && player.energy >= 3) {
    swordActive = true;
    swordEndTime = Date.now() + 30000;
    swordTimer = 0;
    player.energy -= 3;
    document.getElementById("bladeBtn").classList.add("active");}}

function activateDownwardSwords() {
  if (!bladeActive && player.energy >= 6) {
    bladeActive = true;
    bladeEndTime = Date.now() + 30000;
    bladeTimer = 0;
    player.energy -= 6;
    document.getElementById("swordBtn").classList.add("active");}}

// ğŸ–± GÃ¡n sá»± kiá»‡n nÃºt
document.getElementById("bladeBtn").onclick = () => {
  if (player.level < 1) return showWarning("ğŸ”ª Cáº§n Lv1 Ä‘á»ƒ dÃ¹ng Äao");
  activateSwordSkill();};

document.getElementById("swordBtn").onclick = () => {
  if (player.level < 3) return showWarning("âš”ï¸ Cáº§n Lv3 Ä‘á»ƒ dÃ¹ng Kiáº¿m");
  activateDownwardSwords();};

document.getElementById("fireBtn").onclick = () => {
  if (player.level < 5) {
    showWarning("ğŸ”¥ YÃªu cáº§u Lv5 - 8âš¡");
    return;
  }
  if (!fireActive && player.energy >= 8) {
    fireActive = true;
    fireballs.length = 0;
const fireCount = 4; // Sá»‘ lÆ°á»£ng lá»­a
for (let i = 0; i < fireCount; i++) {
  const angle = (2 * Math.PI / fireCount) * i;
  const f = getFireball();
  f.angle = angle;
  f.radius = 40;
  f.x = player.x + Math.cos(angle) * 40;
  f.y = player.y + Math.sin(angle) * 40;
  fireballs.push(f);
}
    fireEndTime = Date.now() + 45000; // Thá»i gian ká»¹ nÄƒng
    player.energy -= 8;
    const btn = document.getElementById("fireBtn");
    btn.classList.add("active");
  }
};

document.getElementById("iceBtn").onclick = () => {
if (player.level < 10) return showWarning("â„ï¸ Cáº§n Lv10 Ä‘á»ƒ dÃ¹ng BÄƒng");
if (!iceActive && player.energy >= 12) {
    iceActive = true;
  iceballs.length = 0;
const iceCount = 6; // Sá»‘ lÆ°á»£ng bÄƒng
for (let i = 0; i < iceCount; i++) {
  const angle = (2 * Math.PI / iceCount) * i;
  const iBall = getIceball();
  iBall.angle = angle;
  iBall.radius = 60;
  iBall.x = player.x + Math.cos(angle) * 60;
  iBall.y = player.y + Math.sin(angle) * 60;
  iceballs.push(iBall);
}

    iceEndTime = Date.now() + 60000;
    player.energy -= 12;
    const btn = document.getElementById("iceBtn");
    btn.classList.add("active");
  }
};
document.getElementById("autoBtn").onclick = () => {
  autoShoot = !autoShoot;
  const btn = document.getElementById("autoBtn");
  if (autoShoot) {
    btn.classList.add("active");
  } else {
    btn.classList.remove("active");
  }
};

//ğŸ§Ÿ 6. Sinh zombie vÃ  boss
// ğŸ¨ MÃ u tÆ°Æ¡ng á»©ng cho zombie cáº¥p 1 â†’ 10
const zombieColorsByLevel = [
  "#00cc66", // Level 1 â€“ Xanh lÃ¡ sÃ¡ng (nháº¹ nhÃ ng)
  "#3399ff", // Level 2 â€“ Xanh dÆ°Æ¡ng (nháº¡t hÆ¡n boss)
  "#ffcc00", // Level 3 â€“ VÃ ng sÃ¡ng
  "#ff9900", // Level 4 â€“ Cam
  "#ff3333", // Level 5 â€“ Äá» sÃ¡ng
  "#cc00cc", // Level 6 â€“ TÃ­m
  "#9933ff", // Level 7 â€“ TÃ­m xanh Ä‘iá»‡n
  "#ff66cc", // Level 8 â€“ Há»“ng neon
  "#00ffff", // Level 9 â€“ Xanh cyan
  "#ffffff"  // Level 10 â€“ Tráº¯ng sÃ¡ng chÃ³i (gáº§n max)
];

// ğŸ“Š Báº£ng xÃ¡c suáº¥t cáº¥p Ä‘á»™ zombie theo tá»«ng wave
function getZombieLevelByWave(wave) {
  const levelTable = {
    1:  [100],
    2:  [70, 30],
    3:  [50, 50],
    4:  [40, 60],
    5:  [30, 70],
    6:  [20, 50, 30],
    7:  [15, 50, 35],
    8:  [10, 50, 40],
    9:  [5, 50, 45],
    10: [0, 50, 50],
    11: [20, 30, 20, 30],
    12: [15, 30, 25, 30],
    13: [10, 30, 30, 30],
    14: [5, 30, 35, 30],
    15: [0, 30, 40, 30],
    16: [0, 20, 40, 40],
    17: [0, 10, 40, 50],
    18: [0, 0, 40, 60],
    19: [0, 0, 30, 70],
    20: [0, 0, 20, 80],
    21: [0, 0, 10, 40, 50],
    22: [0, 0, 5, 35, 60],
    23: [0, 0, 5, 25, 60, 5],
    24: [0, 0, 0, 20, 50, 20, 10],
    25: [0, 0, 0, 15, 40, 25, 15, 5],
    26: [0, 0, 0, 10, 35, 25, 20, 10],
    27: [0, 0, 0, 5, 25, 25, 25, 15, 5],
    28: [0, 0, 0, 0, 20, 25, 25, 20, 10],
    29: [0, 0, 0, 0, 15, 20, 25, 25, 15],
    30: [0, 0, 0, 0, 10, 15, 25, 25, 20, 5]
  };

  // ğŸ‘‡ fallback khi wave > 30: zombie cáº¥p 1â€“10
  const fallback = [1, 1, 10, 10, 15, 15, 15, 15, 10, 8];

  const table = levelTable[wave] || fallback;
  const rand = Math.random() * 100;
  let sum = 0;
  for (let i = 0; i < table.length; i++) {
    sum += table[i];
    if (rand < sum) return i;
  }
  return table.length - 1;
}

 function spawnZombie() {
  const z = getZombie();
  const level = getZombieLevelByWave(wave); // cáº¥p tá»« 0â€“9
// HP zombie tÄƒng theo level player + random 1~10
  if (wave >= 10) {
  z.hp = level + 1 + Math.floor(player.level / 2) + Math.floor(Math.random() * 10 + 1);
} else {
  z.hp = level + 1;
}
  z.level = level + 1; // cáº¥p tháº­t tá»« 1â€“10
  //z.speed = 0.01 + Math.random() * 0.2; // Tá»‘c Ä‘á»™ zombie
  // ğŸ‘£ Di chuyá»ƒn ngáº«u nhiÃªn ban Ä‘áº§u
z.state = "wandering";
z.nextStateCheck = Date.now() + 3000; // kiá»ƒm tra má»—i 3s khi Ä‘ang chasing
z.wanderTime = Date.now() + 2000 + Math.random() * 2000; // tá»« 2 Ä‘áº¿n 4 giÃ¢y
z.wanderAngle = Math.random() * Math.PI * 2;
// ğŸ² Chá»n kiá»ƒu wander: 80% di chuyá»ƒn, 20% Ä‘á»©ng im
z.wanderBehavior = Math.random() < 0.2 ? "pause" : "move";
z.baseSpeed = 0.02 + Math.random() * 0.3; // tá»‘c Ä‘á»™ khi chasing - tá»‘c Ä‘á»™ khi Ä‘uá»•i theo
z.speed = 0.015 + Math.random() * 0.05;   // tá»‘c Ä‘á»™ khi wandering - tá»‘c Ä‘á»™ khi lang thang
//Test1
  z.color = zombieColorsByLevel[level];
  z.type = "normal";
  z.radius = 15;
  z.isBoss = false;

// ğŸ¯ Random mini boss (xuáº¥t hiá»‡n 1%) - Tá»· lá»‡ xuáº¥t hiá»‡n mini boss
if (Math.random() < 0.01) {
  z.type = "miniBoss";
  z.hp = 50 + wave + Math.floor(player.level / 2) + Math.floor(Math.random() * 20 + 1); // HP mini boss tÄƒng theo wave vÃ  level player
  z.color = "#ff3333";
  z.radius = 18;
  z.level = 99; // ÄÃ¡nh dáº¥u riÃªng Ä‘á»ƒ khÃ´ng tÃ­nh cáº¥p thÆ°á»ng
}

  // Tá»a Ä‘á»™ xuáº¥t hiá»‡n
  const side = Math.floor(Math.random() * 4);
  if (side === 0) { z.x = -40; z.y = Math.random() * canvas.height; }
  else if (side === 1) { z.x = canvas.width + 40; z.y = Math.random() * canvas.height; }
  else if (side === 2) { z.x = Math.random() * canvas.width; z.y = -40; }
  else { z.x = Math.random() * canvas.width; z.y = canvas.height + 40; }

  zombies.push(z);
  zombieSpawnedCount++;
}

// MÃ u boss
const bossColors = [
  "#ff3333", // Äá» tÆ°Æ¡i
  "#ff8800", // Cam rá»±c
  "#ffaa00", // VÃ ng cam
  "#00ccff", // Xanh dÆ°Æ¡ng sÃ¡ng
  "#9933ff", // TÃ­m Ä‘áº­m
  "#00ff99", // Xanh ngá»c
  "#ff66cc", // Há»“ng neon
  "#ffffff", // Tráº¯ng láº¡nh
  "#888888", // XÃ¡m tro (boss mÃ¡y mÃ³c)
  "#00ffff"  // Xanh cyan Ã¡nh kim
];

function spawnBoss() {
  const z = getZombie();

  const side = Math.floor(Math.random() * 4);
  if (side === 0) { z.x = -40; z.y = Math.random() * canvas.height; }
  else if (side === 1) { z.x = canvas.width + 40; z.y = Math.random() * canvas.height; }
  else if (side === 2) { z.x = Math.random() * canvas.width; z.y = -40; }
  else { z.x = Math.random() * canvas.width; z.y = canvas.height + 40; }

  z.radius = 30;
  z.canHit = true;
z.baseSpeed = 0.015 + Math.random() * 0.03; // LÆ°u tá»‘c Ä‘á»™ gá»‘c | Tá»‘c Ä‘á»™ boss
z.speed = z.baseSpeed; // Báº¯t Ä‘áº§u báº±ng tá»‘c Ä‘á»™ gá»‘c
  z.isBoss = true;
  // HP boss tÄƒng theo wave vÃ  level player + random 1~100
  z.hp = 100 + wave * 2 + Math.floor(player.level / 2) + Math.floor(Math.random() * 100 + 1);
  z.type = "boss";
  z.level = 100; // level Boss
  z.color = bossColors[Math.floor(Math.random() * bossColors.length)]; // MÃ u boss
  z.active = true;

  zombies.push(z);
  zombieSpawnedCount++;
}

//ğŸ§  7. Cáº­p nháº­t UI â€“ chá»‰ DOM
// ğŸ§Ÿ HÃ m cáº­p nháº­t Wave riÃªng biá»‡t (dÃ¹ng khi wave thay Ä‘á»•i)
function updateWaveUI() {
  document.getElementById("score-bottom").innerText =
    `Lv: ${player.level} | âš¡: ${player.energy} | Wave: ${wave}`;
}

let lastScore = -1, lastLevel = -1, lastEnergy = -1, lastHearts = -1, lastHighScore = -1;

function updateUI() {
  const highScore = Math.max(player.score, parseInt(localStorage.getItem('highScore') || '0'));
  if (player.score > highScore) {
    localStorage.setItem('highScore', player.score);
  }

  if (
    player.score !== lastScore ||
    player.hearts !== lastHearts ||
    highScore !== lastHighScore
  ) {
    lastScore = player.score;
    lastHearts = player.hearts;
    lastHighScore = highScore;
    document.getElementById("score-top").innerText =
      `Äiá»ƒm: ${player.score} | Ká»· lá»¥c: ${highScore} | â¤ï¸: ${player.hearts}`;
  }

  if (
    player.level !== lastLevel ||
    player.energy !== lastEnergy
  ) {
    lastLevel = player.level;
    lastEnergy = player.energy;
    updateWaveUI(); // ğŸ§Ÿ tÃ¡ch riÃªng hiá»ƒn thá»‹ wave
  }
}

// ğŸ§  HÃ m Ä‘iá»u phá»‘i theo tráº¡ng thÃ¡i sword
function updateSwordByState(s) {
  switch (s.state) {
    case 'charging': return updateSwordCharging(s);
    case 'readyToFire': return updateSwordReady(s);
    case 'flying': return updateSwordFlying(s);
    default: return true;
  }
}

// âš™ï¸ Äao Ä‘ang xoay quanh ngÆ°á»i chÆ¡i trong tráº¡ng thÃ¡i "charging"
function updateSwordCharging(s) {
  // Giáº£m thá»i gian xoay cÃ²n láº¡i
  s.chargeFrame--;

  // Cáº­p nháº­t gÃ³c quay & vá»‹ trÃ­ Ä‘ao theo gÃ³c
  s.angle += 0.015;
  s.x = player.x + Math.cos(s.angle) * s.radius;
  s.y = player.y + Math.sin(s.angle) * s.radius;

  // Kiá»ƒm tra va cháº¡m zombie gáº§n Ä‘ao
  checkSwordHitsNearbyZombie(s);

  // âœ… Khi xoay Ä‘á»§ thá»i gian â†’ chuyá»ƒn sang tráº¡ng thÃ¡i "readyToFire"
  if (s.chargeFrame <= 0) {
    s.state = 'readyToFire';
    s.fireDelay = 30; // thá»i gian chá» trÆ°á»›c khi báº¯t Ä‘áº§u bay
  }

  return true; // giá»¯ Ä‘ao trong máº£ng
}

// â³ Äao Ä‘ang chá» sáºµn Ä‘á»ƒ bay ra sau khi xoay xong
function updateSwordReady(s) {
  //  Má»—i Ä‘ao chá»‰ bay khi Ä‘áº¿n lÆ°á»£t mÃ¬nh
  if (s.fireOrder === nextFireIndex) {
    s.fireDelay--;
    if (s.fireDelay <= 0) {
      s.state = 'flying';
      s.target = findActiveZombie();
      nextFireIndex++; // chuyá»ƒn lÆ°á»£t sang Ä‘ao tiáº¿p theo
    }
  }

  return true;
}

// ğŸš€ Äao bay vá» phÃ­a má»¥c tiÃªu (zombie)
function updateSwordFlying(s) {
  // Náº¿u khÃ´ng cÃ³ target hoáº·c zombie Ä‘Ã£ cháº¿t â†’ tÃ¬m láº¡i zombie má»›i
  if (!s.target || !s.target.active) {
    s.target = findActiveZombie();
    if (!s.target) return true; // chÆ°a cÃ³ zombie â†’ giá»¯ Ä‘ao chá» tiáº¿p
  }

  // Di chuyá»ƒn Ä‘ao hÆ°á»›ng tá»›i má»¥c tiÃªu
  moveSwordTowardsTarget(s);

  // Kiá»ƒm tra va cháº¡m vá»›i má»¥c tiÃªu
  if (distance(s, s.target) < 25) {
    handleSwordHit(s); // xá»­ lÃ½ trÃºng Ä‘á»‹ch
    return false;      // loáº¡i Ä‘ao sau khi trÃºng
  }

  return true; // tiáº¿p tá»¥c bay
}

// ğŸ“ Di chuyá»ƒn Ä‘ao bay Ä‘áº¿n má»¥c tiÃªu
function moveSwordTowardsTarget(s) {
  const dx = s.target.x - s.x;
  const dy = s.target.y - s.y;
  const angle = Math.atan2(dy, dx);
  s.x += Math.cos(angle) * 5;
  s.y += Math.sin(angle) * 5;
}

// ğŸ’¥ Xá»­ lÃ½ khi Ä‘ao bay trÃºng má»¥c tiÃªu
function handleSwordHit(s) {
  s.target.hp -= playerUpgrades.damageBoost || 1;
  if (!s.target._killed && s.target.hp <= 0) {
    killZombie(s.target);
  }
  explosions.push(getExplosion(s.target.x, s.target.y));
}

// ğŸ§¿ TÃ¬m zombie cÃ²n sá»‘ng gáº§n player nháº¥t
function findActiveZombie() {
  return zombies.find(z => z.active);
}

function checkSwordHitsNearbyZombie(s) {
  const target = zombies.find(z => z.active && distance(s, z) < 20);
  if (target) {
    target.hp -= playerUpgrades.damageBoost || 1;
    if (!target._killed && target.hp <= 0) killZombie(target);
    explosions.push(getExplosion(target.x, target.y));
  }
}

//ğŸ”„ 8. Cáº­p nháº­t logic game (Main loop logic)
function update() {
  if (!gameStarted || gameOver || isPaused) return; // ğŸ›‘ Dá»«ng náº¿u Ä‘ang pause
  // Cáº­p nháº­t wave logic
  if (!gameStarted || gameOver) return; // ğŸš« Náº¿u chÆ°a báº¯t Ä‘áº§u hoáº·c Ä‘Ã£ Game Over thÃ¬ dá»«ng

  // â± Äáº¿m thá»i gian cÃ²n láº¡i cá»§a wave
if (lastWaveTime) {
  const elapsed = (Date.now() - lastWaveTime) / 1000; // giÃ¢y Ä‘Ã£ trÃ´i qua
  const remaining = Math.max(0, waveTime - elapsed);  // thá»i gian cÃ²n láº¡i
const min = Math.floor(remaining / 60);
const sec = Math.floor(remaining % 60);
const ms = Math.floor((remaining - Math.floor(remaining)) * 100); // láº¥y 2 chá»¯ sá»‘ sau dáº¥u .
document.getElementById("waveTimerDisplay").innerText =
  `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}:${ms.toString().padStart(2, '0')}`;

if (remaining <= 0) {
  wave++;
  pendingWave = wave;         // ğŸŒŠ lÆ°u wave Ä‘á»ƒ hiá»ƒn thá»‹ sau
  showUpgradePopup();         // ğŸ hiá»ƒn thá»‹ nÃ¢ng cáº¥p trÆ°á»›c
  lastWaveTime = Date.now();  // â±ï¸ reset timer
  updateWaveUI();
}
}

// Xá»­ lÃ½ ká»¹ nÄƒng Äao ğŸ”ª tá»± táº¡o liÃªn tá»¥c trong 30s
if (swordActive) {
  if (Date.now() >= swordEndTime) {
    swordActive = false;
    swords.length = 0;
    document.getElementById("bladeBtn").classList.remove("active");
    document.getElementById("bladeBtn").innerText = "ğŸ”ª Äao";
  } else {
    const remain = Math.ceil((swordEndTime - Date.now()) / 1000);
    document.getElementById("bladeBtn").innerText = `ğŸ”ª ${remain}s`;

    // Táº¡o thanh Ä‘ao
if (swords.length === 0) {
  swordTimer = 0;
  const count = 8; // hoáº·c 12 tÃ¹y báº¡n muá»‘n bao nhiÃªu Ä‘ao
  nextFireIndex = 0;
for (let i = 0; i < count; i++) {
  const angle = (2 * Math.PI / count) * i;
  const s = getSword(); // hoáº·c táº¡o sword má»›i
  s.angle = angle;
  s.radius = 60;
  s.state = 'charging';
  s.chargeFrame = 90;
  s.fireDelay = 20 + i * 10; // tá»«ng Ä‘ao delay khÃ¡c nhau
  s.fireOrder = i; //  Ä‘Ã¡nh sá»‘ Ä‘ao
  swords.push(s);
}
}
  }
}
// ğŸ¯ Tá»‘i Æ°u xá»­ lÃ½ tráº¡ng thÃ¡i cá»§a swords
swords = swords.filter(updateSwordByState);

// === Xá»¬ LÃ Ká»¸ NÄ‚NG KIáº¾M (tá»« trÃªn cao) ===
 if (bladeActive) {
  if (Date.now() >= bladeEndTime) {
    bladeActive = false;
    downwardSwords.length = 0;
    document.getElementById("swordBtn").classList.remove("active");
    document.getElementById("swordBtn").innerText = "âš”ï¸ Kiáº¿m";
  } else {
    const remain = Math.ceil((bladeEndTime - Date.now()) / 1000);
    document.getElementById("swordBtn").innerText = `âš”ï¸ ${remain}s`;

   // ğŸŒ§ï¸ Táº¡o mÆ°a kiáº¿m má»—i 12 frame
if (frame % 12 === 0) {
  const count = Math.floor(Math.random() * 2) + 1; // chá»‰ 1â€“2 kiáº¿m má»—i Ä‘á»£t
  for (let i = 0; i < count; i++) {
    const x = Math.random() * canvas.width;
    downwardSwords.push({
      x,
      y: -20,
      speed: 5 + Math.random() * 1.5 // rÆ¡i mÆ°á»£t
    });
  }
}
    // ğŸ¯ Di chuyá»ƒn vÃ  xá»­ lÃ½ kiáº¿m rÆ¡i
downwardSwords.forEach((s, si) => {
  s.y += s.speed;

  zombies.forEach((z) => {
    if (!z.active) return;
    if (distance(s, z) < 25) {
      z.hp -= playerUpgrades.damageBoost || 1;
      if (!z._killed && z.hp <= 0) killZombie(z);
      explosions.push(getExplosion(z.x, z.y));
    }
  });
});

// âŒ XoÃ¡ kiáº¿m rÆ¡i quÃ¡ mÃ n hÃ¬nh
downwardSwords = downwardSwords.filter(s => s.y < canvas.height + 30);
  }
}

if (gameOver) return;

// ğŸ” Giáº£m thá»i gian miá»…n sÃ¡t thÆ°Æ¡ng
if (player.hitTimer > 0) {
  player.hitTimer--;
}

  // Player move
let moveX = 0;
let moveY = 0;

if (keys.w) moveY -= 1;
if (keys.s) moveY += 1;
if (keys.a) moveX -= 1;
if (keys.d) moveX += 1;

if (moveX !== 0 || moveY !== 0) {
  const length = Math.hypot(moveX, moveY);
  moveX /= length;
  moveY /= length;
  player.x += moveX * player.speed;
  player.y += moveY * player.speed;
}

// === Xá»­ lÃ½ Ä‘iá»u khiá»ƒn cáº£m á»©ng ===
if (touchStartX !== null && touchMoveX !== null) {
  let dx = touchMoveX - touchStartX;
  let dy = touchMoveY - touchStartY;
  const len = Math.hypot(dx, dy);
  if (len > 10) { // chá»‰ di chuyá»ƒn náº¿u vuá»‘t Ä‘á»§ lá»›n
    dx /= len;
    dy /= len;
    player.x += dx * player.speed;
    player.y += dy * player.speed;
  }
}

if (autoShoot && player.level >= 1) autoShootBurst();

  // === Ká»¹ nÄƒng Lá»¬A ===
  if (fireActive) {
    const remaining = Math.ceil((fireEndTime - Date.now()) / 1000);
    const fireBtn = document.getElementById("fireBtn");
    if (remaining > 0) {
      fireBtn.innerText = `ğŸ”¥ ${remaining}s`;
    } else {
fireActive = false;
fireballs.forEach(f => releaseFireball(f));
fireballs.length = 0;
fireBtn.innerText = "ğŸ”¥ Lá»­a";
fireBtn.classList.remove("active");
    }}

  // === Ká»¹ nÄƒng BÄ‚NG ===
  if (iceActive) {
    const remaining = Math.ceil((iceEndTime - Date.now()) / 1000);
    const iceBtn = document.getElementById("iceBtn");
    if (remaining > 0) {
      iceBtn.innerText = `â„ï¸ ${remaining}s`;
    } 
else {
iceActive = false;
iceballs.forEach(i => releaseIceball(i));
iceballs.length = 0;
iceBtn.innerText = "â„ï¸ BÄƒng";
iceBtn.classList.remove("active");
}}

updateBullets(); // gá»i hÃ m Ä‘Ã£ viáº¿t sá»­ dá»¥ng object pooling

  zombies.forEach((z, zi) => {
//    const angle = Math.atan2(player.y - z.y, player.x - z.x);
//z.x += Math.cos(angle) * z.speed;
//z.y += Math.sin(angle) * z.speed;
// ğŸ‘£ Cáº­p nháº­t hÆ°á»›ng di chuyá»ƒn theo tráº¡ng thÃ¡i
// ğŸ§  AI hÃ nh vi zombie
if (z.state === "wandering") {
  if (Date.now() >= z.wanderTime) {
    z.state = "chasing";
    z.speed = z.baseSpeed;
    z.nextStateCheck = Date.now() + 3000;
  } else {
    // ğŸ‘£ Di chuyá»ƒn hoáº·c Ä‘á»©ng yÃªn
    if (z.wanderBehavior === "move") {
      z.x += Math.cos(z.wanderAngle) * z.speed;
      z.y += Math.sin(z.wanderAngle) * z.speed;
    }
    // Náº¿u pause thÃ¬ khÃ´ng lÃ m gÃ¬ (Ä‘á»©ng yÃªn)
  }
} else if (z.state === "chasing") {
  if (Date.now() >= z.nextStateCheck) {
    z.nextStateCheck = Date.now() + 3000;

    // âŒ Boss khÃ´ng Ä‘Æ°á»£c chuyá»ƒn sang wandering
    if (!z.isBoss && Math.random() < 0.05) {
      z.state = "wandering";
      z.wanderTime = Date.now() + 1500 + Math.random() * 8500; // Thá»i gian Zzz tá»« 1.5s - 10s
      z.wanderAngle = Math.random() * Math.PI * 2;
      z.speed = 0.15 + Math.random() * 0.05;
      z.wanderBehavior = Math.random() < 0.2 ? "pause" : "move"; // 20% Ä‘á»©ng
      return;
    }
  }

  // ğŸ‘Š Náº¿u váº«n chasing â†’ Ä‘uá»•i theo player
  const angle = Math.atan2(player.y - z.y, player.x - z.x);
  z.x += Math.cos(angle) * z.speed;
  z.y += Math.sin(angle) * z.speed;
}
//Test2
// Zombie báº¯n tráº£
// ğŸ§  Boss hoáº·c mini boss báº¯n 1 láº§n má»—i 10 giÃ¢y
if (z.isBoss || z.type === "miniBoss") {
  if (!z.lastShoot) z.lastShoot = 0;
  const now = Date.now();
if (now - z.lastShoot >= 10000) {
  z.lastShoot = now; // 
  if (Math.random() < 0.2) { // ğŸ’¥ 20% xÃ¡c suáº¥t má»—i 10s
    const dx = player.x - z.x;
    const dy = player.y - z.y;
    const angle = Math.atan2(dy, dx);
    enemyBullets.push({
      x: z.x,
      y: z.y,
      dx: Math.cos(angle),
      dy: Math.sin(angle),
      speed: 0.8,
      hit: false
    });
  }
}
}
// ğŸ‘¾ Zombie thÆ°á»ng chá»‰ báº¯n sau má»—i 15s vÃ  cÃ³ 5% xÃ¡c suáº¥t
if (!z.isBoss && z.type !== "miniBoss") {
  if (!z.lastShoot) z.lastShoot = 0;
  const now = Date.now();
  if (now - z.lastShoot >= 15000) {
    z.lastShoot = now;
    if (Math.random() < 0.05) {
      const dx = player.x - z.x;
      const dy = player.y - z.y;
      const angle = Math.atan2(dy, dx);
      enemyBullets.push({
        x: z.x,
        y: z.y,
        dx: Math.cos(angle),
        dy: Math.sin(angle),
        speed: 0.6 + Math.random() * 0.4,
        hit: false
      });
    }
  }
}

    if (distance(z, player) < z.radius + player.size) {
  if (z.canHit) {
    player.hearts--;
    explosions.push(getExplosion(z.x, z.y));
    z.canHit = false;

    // Cho phÃ©p zombie Ä‘Ã¡nh láº¡i sau 500ms
    setTimeout(() => { z.canHit = true; }, 500);

    if (player.hearts <= 0) {
      gameOver = true;
      document.getElementById("gameOverPanel").style.display = "flex";
    }
  }

  // Ä‘áº©y zombie ra khá»i player
  const dx = z.x - player.x;
  const dy = z.y - player.y;
  const angle = Math.atan2(dy, dx);
  const pushBack = (z.radius + player.size - distance(z, player)) + 1;
  z.x += Math.cos(angle) * pushBack;
  z.y += Math.sin(angle) * pushBack;
}
  });

  // ğŸ”¥ Lá»­a
// ğŸ”¥ Cáº­p nháº­t fireballs - ká»¹ nÄƒng lá»­a quay quanh player vÃ  gÃ¢y sÃ¡t thÆ°Æ¡ng
fireballs = fireballs.filter(f => {
  // Cáº­p nháº­t vá»‹ trÃ­ fireball quay quanh player
  f.angle += 0.05;
  f.x = player.x + Math.cos(f.angle) * f.radius;
  f.y = player.y + Math.sin(f.angle) * f.radius;

  // Kiá»ƒm tra va cháº¡m vá»›i zombie
  zombies.forEach(z => {
    if (!z.active) return;
    if (distance(f, z) < 25) {
      z.hp -= playerUpgrades.damageBoost || 1;
      if (z.hp <= 0) killZombie(z);
      explosions.push(getExplosion(z.x, z.y));
    }
  });

  // Giá»¯ láº¡i náº¿u ká»¹ nÄƒng váº«n Ä‘ang hoáº¡t Ä‘á»™ng
  return fireActive;
});

// â„ï¸ BÄƒng
// â„ï¸ Cáº­p nháº­t iceballs - ká»¹ nÄƒng bÄƒng quay quanh player vÃ  gÃ¢y sÃ¡t thÆ°Æ¡ng
iceballs = iceballs.filter(f => {
  // Cáº­p nháº­t vá»‹ trÃ­ iceball quay quanh player
  f.angle += 0.03;
  f.x = player.x + Math.cos(f.angle) * f.radius;
  f.y = player.y + Math.sin(f.angle) * f.radius;

  // Kiá»ƒm tra va cháº¡m vá»›i zombie
  zombies.forEach(z => {
    if (!z.active) return;
    if (distance(f, z) < 25) {
      z.hp -= playerUpgrades.damageBoost || 1;
      if (z.hp <= 0) killZombie(z);
      explosions.push(getExplosion(z.x, z.y));
    }
  });

  // Giá»¯ láº¡i náº¿u ká»¹ nÄƒng váº«n Ä‘ang hoáº¡t Ä‘á»™ng
  return iceActive;
});

  // Nháº·t item âš¡
  items.forEach(it => {
  if (!it.active) return;
  if (distance(it, player) < 20) {
    player.energy += 1;
    it.active = false;
  }
});
items = items.filter(it => it.active);

const requiredScore = player.level * 10; // TÄƒng level #TÄƒng cáº¥p
if (player.score >= requiredScore) {
  player.level++;
  player.hearts += 1 + (UPGRADE_TIERS.hpBoost[playerUpgrades.hpBoost] || 0);
  player.energy += 2; // ğŸ thÆ°á»Ÿng 2 nÄƒng lÆ°á»£ng khi lÃªn cáº¥p

  // âœ¨ Äá»•i ná»n theo level
const levelBackgrounds = [
  "radial-gradient(circle at center, #2c3e50, #000000)",        // Lv1: Xanh Ä‘Ãªm hiá»‡n Ä‘áº¡i
  "radial-gradient(circle at center, #4b79a1, #283e51)",         // Lv2: Xanh trá»i láº¡nh
  "radial-gradient(circle at center, #1e3c72, #2a5298)",         // Lv3: Biá»ƒn sÃ¢u
  "radial-gradient(circle at center, #8e44ad, #2c3e50)",         // Lv4: TÃ­m khÃ´ng gian
  "radial-gradient(circle at center, #e96443, #904e95)",         // Lv5: Cam tÃ­m má»™ng mÆ¡
  "radial-gradient(circle at center, #ff512f, #dd2476)",         // Lv6: Nhiá»‡t huyáº¿t
  "radial-gradient(circle at center, #00bf8f, #001510)",         // Lv7: Lá»¥c báº£o ngá»c
  "radial-gradient(circle at center, #2980b9, #6dd5fa)",         // Lv8: MÃ¢y xanh dá»‹u
  "radial-gradient(circle at center, #f7971e, #ffd200)",         // Lv9: Náº¯ng vÃ ng
  "radial-gradient(circle at center, #1f4037, #99f2c8)",          // Lv10: Rá»«ng mÃ¡t
  "radial-gradient(circle at center, #ffffff33, #00ffff22, #000000)" // level 11+
];

let bg;
if (player.level <= 11) {
  bg = levelBackgrounds[player.level - 1];
} else {
  bg = generateGradient(player.level);
}
canvas.style.background = bg;

  // ğŸª„ Hiá»ƒn thá»‹ popup level
  const popup = document.getElementById("levelUpPopup");
  popup.style.animation = "none"; // reset náº¿u Ä‘Ã£ cÃ³ hiá»‡u á»©ng trÆ°á»›c Ä‘Ã³
  void popup.offsetWidth;         // trigger reflow
  popup.style.display = "block";
  setTimeout(() => {
    popup.style.display = "none";
  }, 1200);
  levelUpGlowTime = 60; // ~1s sÃ¡ng vÃ ng

  // ğŸ¯ Má»—i 2 cáº¥p gá»i boss
  if (player.level % 1 === 0) {
spawnBoss();
}}
  updateExplosions(); // dÃ¹ng object pooling thay splice

if (levelUpGlowTime > 0) levelUpGlowTime--;

// ğŸ¯ Cáº­p nháº­t bullets â€“ dÃ¹ng object pooling thay vÃ¬ splice
function updateBullets() {
  for (let i = 0; i < bullets.length; i++) {
    const b = bullets[i];
    if (!b.active) continue;

    // ğŸƒ Di chuyá»ƒn Ä‘áº¡n theo hÆ°á»›ng vÃ  tá»‘c Ä‘á»™ lÆ°u riÃªng
    b.x += b.dx * b.speed;
    b.y += b.dy * b.speed;

for (let j = 0; j < zombies.length; j++) {
  const z = zombies[j];
  if (!z.active) continue;

  if (distance(b, z) < 20) {
    if (z.hp > 0) {
      z.hp -= playerUpgrades.damageBoost || 1;
      if (z.hp <= 0) {
        killZombie(z);
      }
    }

    explosions.push(getExplosion(z.x, z.y));
    releaseBullet(b);
    break; // chá»‰ break sau khi Ä‘áº¡n thá»±c sá»± xá»­ lÃ½ xong
  }
}
  }

  bullets = bullets.filter(b => b.active);
}

function updateEnemyBullets() {
  for (let i = 0; i < enemyBullets.length; i++) {
    const b = enemyBullets[i];
    b.x += b.dx * b.speed;
    b.y += b.dy * b.speed;

    // Náº¿u trÃºng ngÆ°á»i chÆ¡i
if (distance(b, player) < 15) {
  if (player.hitTimer === 0) {
    player.hearts--;
    player.hitTimer = 30;
    explosions.push(getExplosion(b.x, b.y));
    
    if (player.hearts <= 0) {
      gameOver = true;
      document.getElementById("gameOverPanel").style.display = "flex";
    }
  }
  b.hit = true;
}
  }

  // Loáº¡i bá» Ä‘áº¡n bay ra ngoÃ i hoáº·c Ä‘Ã£ trÃºng
  enemyBullets = enemyBullets.filter(b => 
    !b.hit &&
    b.x >= -20 && b.x <= canvas.width + 20 &&
    b.y >= -20 && b.y <= canvas.height + 20
  );
}

// ğŸ’¥ Cáº­p nháº­t hiá»‡u á»©ng ná»• â€“ thay tháº¿ splice báº±ng release
function updateExplosions() {
  explosions.forEach(e => {
    if (!e.active) return;
    e.radius += 2;
    e.life--;
    if (e.life <= 0) {
      releaseExplosion(e);
    }
  });
}

zombies = zombies.filter(z => z.active);

  updateUI();
  updateStatsOverlay();
  updateEnemyBullets();
}

//ğŸ¨ 9. Váº½ khung hÃ¬nh (draw canvas)
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
if (levelUpGlowTime > 0) {
  ctx.shadowBlur = 8;
  ctx.shadowColor = "gold";
  ctx.fillStyle = "gold";
} else {
  ctx.shadowBlur = 0;
  ctx.shadowColor = "transparent"; // thÃªm dÃ²ng nÃ y Ä‘á»ƒ táº¯t sÃ¡ng háº³n
  ctx.fillStyle = (player.hitTimer % 10 < 5) ? "#ff4c4c" : "#00ff00";
}
ctx.fill();
ctx.lineWidth = 2.2;
ctx.strokeStyle = "rgba(0, 255, 255, 0.4)"; // mÃ u cyan nháº¡t
ctx.shadowColor = "rgba(0, 255, 255, 0.25)"; // phÃ¡t sÃ¡ng nháº¹
ctx.stroke();
  bullets.forEach(b => {
  if (!b.active) return; // ğŸ›¡ bá» qua Ä‘áº¡n Ä‘Ã£ bá»‹ gá»¡
  ctx.beginPath();
  ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
  ctx.fillStyle = "yellow";
  ctx.fill();
});

// ğŸ”« Váº½ Ä‘áº¡n tá»« boss & mini boss
enemyBullets.forEach(b => {
  ctx.beginPath();
  ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
  ctx.fillStyle = "red";
  ctx.fill();
});

zombies.forEach(z => {
    if (!z.active) return;
ctx.save();

// âœ¨ Hiá»‡u á»©ng glow cho Boss & Mini Boss
if (z.isBoss || z.type === "miniBoss") {
  ctx.shadowColor = z.color || "#ffffff";
  ctx.shadowBlur = z.isBoss ? 10 : 5; // Boss sÃ¡ng máº¡nh hÆ¡n
} else {
  ctx.shadowColor = "transparent";
  ctx.shadowBlur = 0;
}

ctx.beginPath();
ctx.arc(z.x, z.y, z.radius, 0, Math.PI * 2);
ctx.fillStyle = z.color || (z.isBoss ? "red" : "hotpink");
ctx.fill();

ctx.restore();

// ğŸ‘‡ Font dá»±a vÃ o bÃ¡n kÃ­nh zombie Ä‘á»ƒ scale
ctx.font = `${z.radius * 1.5}px serif`;

// ğŸ‘‡ CÄƒn giá»¯a chuáº©n cho icon
ctx.textAlign = "center";
ctx.textBaseline = "middle";

// ğŸ‘‡ Váº½ icon ngay giá»¯a hÃ¬nh trÃ²n
ctx.fillText(z.isBoss ? "ğŸ’€" : "ğŸ§Ÿ", z.x, z.y);
//
// ğŸ’¬ Icon tráº¡ng thÃ¡i zombie náº¿u Ä‘ang lang thang
if (!z.isBoss && z.state === "wandering") {
  ctx.save();
  ctx.font = `${z.radius * 1.2}px sans-serif`;
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
  ctx.fillStyle = "#fff";

  // Hiá»ƒn thá»‹ icon tÃ¹y theo hÃ nh vi
  //const icon = z.wanderBehavior === "pause" ? "ğŸ’¤" : "ğŸ˜–";
  //ctx.fillText(icon, z.x + z.radius + 8, z.y + z.radius - 15);
  const icon = z.wanderBehavior === "pause" ? "ğŸ’¤" : "ğŸ˜–";
ctx.fillText(icon, z.x + z.radius + 8, z.y + z.radius - 15);
//Test5
  ctx.restore();
}
//Test3
// ğŸ§  Hiá»ƒn thá»‹ HP cÃ²n láº¡i trÃªn Ä‘áº§u zombie thÆ°á»ng
if (!z.isBoss) {
  ctx.save();
  ctx.fillStyle = z.color || "#fff";
  ctx.font = `${z.radius * 0.9}px monospace`;
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
// ğŸ‘‡ Hiá»ƒn thá»‹ cáº¥p Ä‘á»™ zombie = aâ€“j (97 = 'a')
const levelChar = String.fromCharCode(96 + z.level);
const hpColor = z.color || "#fff";
const divider = "-" // ğŸ‘ˆ hoáº·c " ", ".", "*"

ctx.save();
ctx.font = `${z.radius * 0.9}px 'Trebuchet MS', sans-serif`;
ctx.textAlign = "center";
ctx.textBaseline = "bottom";
ctx.fillStyle = hpColor;

// Hiá»ƒn thá»‹ vÃ­ dá»¥: a-22 (cáº¥p 1, HP 22)
ctx.fillText(`${levelChar}${divider}${z.hp}`, z.x, z.y - z.radius - 4);
ctx.restore();
}

  if (z.isBoss) {
ctx.save();
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillStyle = z.color || "#ffffff"; // ğŸ¨ chá»¯ cÃ¹ng mÃ u boss
ctx.font = `${z.radius * 0.03}rem sans-serif`; // tá»‰ lá»‡ há»£p lÃ½ hÆ¡n
ctx.fillText(`Boss: ${z.hp}`, z.x, z.y - z.radius - z.radius * 0.3);
ctx.restore();
}
});
// ğŸ¯ Váº½ icon biá»ƒu cáº£m sau cÃ¹ng Ä‘á»ƒ luÃ´n ná»•i trÃªn boss
zombies.forEach(z => {
  if (!z.iconToDraw) return;

  ctx.save();
  ctx.font = `${z.radius * 1.2}px serif`;
  ctx.textAlign = "left";
  ctx.textBaseline = "middle";
  ctx.fillStyle = "#fff";
  ctx.shadowColor = "#000";
  ctx.shadowBlur = 6;

  // giá»¯ Ä‘Ãºng vá»‹ trÃ­ báº¡n Ä‘áº·t: gÃ³c pháº£i dÆ°á»›i
  ctx.fillText(z.iconToDraw, z.x + z.radius + 8, z.y + z.radius - 15);
  ctx.restore();
});

// Máº¯t vÃ  miá»‡ng xoay theo hÆ°á»›ng zombie gáº§n nháº¥t
if (zombies.length > 0) {
  const target = zombies.reduce((a, b) => distance(a, player) < distance(b, player) ? a : b);
  const angle = Math.atan2(target.y - player.y, target.x - player.x);
  const eyeOffsetX = Math.cos(angle) * 6;
  const eyeOffsetY = Math.sin(angle) * 6;
  const mouthOffsetX = Math.cos(angle) * 10;
  const mouthOffsetY = Math.sin(angle) * 10;

  // Máº¯t trÃ¡i
  ctx.beginPath();
  ctx.arc(player.x + eyeOffsetX - 4, player.y + eyeOffsetY - 4, 2, 0, Math.PI * 2);
  ctx.fillStyle = "white";
  ctx.fill();

  // Máº¯t pháº£i
  ctx.beginPath();
  ctx.arc(player.x + eyeOffsetX + 4, player.y + eyeOffsetY - 4, 2, 0, Math.PI * 2);
  ctx.fill();

  // Miá»‡ng
  ctx.beginPath();
  ctx.arc(player.x + mouthOffsetX, player.y + mouthOffsetY + 3, 2, 0, Math.PI);
  ctx.strokeStyle = "white";
  ctx.lineWidth = 1;
  ctx.stroke();
}

explosions.forEach(e => {
  ctx.beginPath();
  ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
  ctx.fillStyle = `rgba(255, 200, 0, ${e.life / 20})`;
  ctx.fill();
});

drawItems();
drawEffects();

// ğŸ¨ Váº½ váº­t pháº©m energy âš¡
function drawItems() {
  items.forEach(it => {
    if (!it.active) return;
    ctx.save();
    ctx.font = "0.8rem serif"; // KÃ­ch thÆ°á»›c váº­t pháº©m
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.shadowBlur = 10;
    ctx.shadowColor = "gold";
    ctx.fillStyle = "gold";
    const bob = Math.sin(frame / 10 + it.x + it.y) * 2;
    ctx.fillText("âš¡", it.x, it.y + bob);
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#000";
    ctx.strokeText("âš¡", it.x, it.y + bob);
    ctx.restore();
  });
}
}

// ğŸ¨ Váº½ táº¥t cáº£ hiá»‡u á»©ng ká»¹ nÄƒng gá»n láº¡i
function drawEffects() {
  fireballs.forEach(f => {
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.shadowBlur = 15;
    ctx.shadowColor = "orange";
    ctx.fillStyle = "orange";
    ctx.font = "1.3rem serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ğŸ”¥", 0, 0);
    ctx.restore();
  });

  iceballs.forEach(f => {
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.shadowBlur = 15;
    ctx.shadowColor = "#00e5ff";
    ctx.fillStyle = "#00e5ff";
    ctx.font = "1.3rem serif";
    // ctx.font = (f.radius * 0.9) + " serif"; Ká»¹ nÄƒng to ra khi lÃªn level
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("â„ï¸", 0, 0);
    ctx.restore();
  });

  swords.forEach(s => {
    ctx.save();
    ctx.translate(s.x, s.y);
    if (s.state === 'charging') {
  ctx.shadowBlur = 2; // Hiá»‡u á»©ng bÃ³ng má»
  ctx.shadowColor = '#00ffff';
  ctx.fillStyle = '#00ffff';
} else {
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'white';
}
    ctx.font = "1.2rem serif";
    //ctx.font = (s.radius * 0.9) + " serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("ğŸ”ª", 0, 0);
    ctx.restore();
  });

downwardSwords.forEach(s => {
  ctx.save();
  ctx.translate(s.x, s.y);
  ctx.shadowBlur = 15;
  ctx.shadowColor = '#00ffff';
  ctx.fillStyle = 'white';
  ctx.font = "1.2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("âš”ï¸", 0, 0);
  ctx.restore();
});
}

//ğŸ” 10. VÃ²ng láº·p chÃ­nh vÃ  khá»Ÿi táº¡o game
function loop() {
update();
draw();
frame++;
if (frame % 120 === 0 && gameStarted) {
  if (zombies.length < 50) {
    const spawnCount = Math.min(1, 50 - zombies.length); // Giá»›i háº¡n zombie
    for (let i = 0; i < spawnCount; i++) {
      spawnZombie();
    }
  }
}

requestAnimationFrame(loop);}

// â–¶ï¸ Khá»Ÿi cháº¡y ban Ä‘áº§u
spawnZombie();
loop();

//ğŸ§¼ 11. CÃ¡c Ä‘oáº¡n khá»Ÿi táº¡o UI sau canvas
// HÃ m báº¯t Ä‘áº§u game
function startGame() {
  document.getElementById("startMenu").style.display = "none";
  gameStarted = true;
  //Test
  // ğŸš€ TÄƒng nhanh Ä‘á»ƒ test wave 20+
  //wave = 11;
  //player.level = 11;
  //player.score = player.level * 10; // Äáº£m báº£o Ä‘á»§ Ä‘iá»ƒm Ä‘á»ƒ khÃ´ng bá»‹ tá»¥t cáº¥p
  //Test
  waveTimer = waveTime;
  showUpgradePopup();        // ğŸ Gá»i nÃ¢ng cáº¥p trÆ°á»›c
  pendingWave = wave;        // ğŸŒŠ Wave sáº½ hiá»ƒn thá»‹ sau khi nÃ¢ng cáº¥p xong
}

// ğŸŒŠ Hiá»‡n popup "Wave X báº¯t Ä‘áº§u"
function showWavePopup() {
  const popup = document.getElementById("wavePopup");
  popup.innerText = `Wave ${wave} báº¯t Ä‘áº§u!`;
  popup.style.animation = "none";
  void popup.offsetWidth; // force reflow Ä‘á»ƒ reset animation
  popup.style.display = "block";
  popup.style.animation = "waveFade 1s ease-out forwards";
  setTimeout(() => {
    popup.style.display = "none";
  }, 2000); // áº©n sau 2 giÃ¢y
}

// ğŸ¯ GiÃ¡ trá»‹ theo cáº¥p Ä‘á»™ ká»¹ nÄƒng (má»—i cáº¥p tÄƒng dáº§n)
const UPGRADE_TIERS = {
  fireRate: [1, 2, 3],
  damageBoost: [0.5, 1, 1.5],
  hpBoost: [2, 3, 5],            
  bulletSpeed: [0.25, 0.5, 1]
};

// ğŸŒŸ Hiá»ƒn thá»‹ popup chá»n nÃ¢ng cáº¥p ká»¹ nÄƒng
function showUpgradePopup() {
  const popup = document.getElementById("upgradePopup");
  const container = document.getElementById("upgradeChoices");
  container.innerHTML = "";

  // ğŸ“Œ Báº£ng giÃ¡ trá»‹ tÆ°Æ¡ng á»©ng vá»›i tá»«ng báº­c nÃ¢ng cáº¥p
const UPGRADE_VALUES = {
  Báº¡c:  { fireRate: 1, damageBoost: 0.5, hpBoost: 2, bulletSpeed: 0.25 },
  VÃ ng: { fireRate: 2,  damageBoost: 1,   hpBoost: 3, bulletSpeed: 0.5 },
  Kim:  { fireRate: 3,    damageBoost: 1.5, hpBoost: 5, bulletSpeed: 1 },
  Rare: { moveSpeed: 0.2 } // ğŸ‘Ÿ tá»‘c Ä‘á»™ cháº¡y â€“ báº­c hiáº¿m
};
  // ğŸ– MÃ u viá»n tÆ°Æ¡ng á»©ng tá»«ng báº­c
const TIER_COLORS = {
  Báº¡c: "#aaa",
  VÃ ng: "gold",
  Kim: "#c770ff",
  Rare: "#3399ff" // ğŸ’š mÃ u xanh báº­c hiáº¿m
};

const MAX_FIRE_RATE = 21;
const MAX_LINE_BULLETS = 10;
const MAX_MOVE_SPEED = 3;

const allUpgrades = [];

// ğŸ”« HÆ°á»›ng báº¯n â€“ náº¿u chÆ°a max
if (playerUpgrades.fireRate < MAX_FIRE_RATE) {
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].fireRate;
  allUpgrades.push({
    name: "ğŸ”« HÆ°á»›ng báº¯n",
    key: "fireRate",
    tier,
    value,
effect: () => {
  const added = Math.min(playerUpgrades.fireRate + value, MAX_FIRE_RATE) - playerUpgrades.fireRate;
  playerUpgrades.fireRate += added;
  showWarning(`ğŸ”« +${added} hÆ°á»›ng báº¯n`);
  updateStatsOverlay();
}
  });
}

// ğŸ’¥ SÃ¡t thÆ°Æ¡ng â€“ luÃ´n cÃ³ thá»ƒ nÃ¢ng
{
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].damageBoost;
  allUpgrades.push({
    name: "ğŸ’¥ SÃ¡t thÆ°Æ¡ng",
    key: "damageBoost",
    tier,
    value,
effect: () => {
  playerUpgrades.damageBoost += value;
  showWarning(`ğŸ’¥ +${value} sÃ¡t thÆ°Æ¡ng`);
  updateStatsOverlay();
}
  });
}

// â¤ï¸ MÃ¡u â€“ luÃ´n cÃ³ thá»ƒ nÃ¢ng
{
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].hpBoost;
  allUpgrades.push({
    name: "â¤ï¸ TÄƒng mÃ¡u",
    key: "hpBoost",
    tier,
    value,
    effect: () => {
      player.hearts += value;
      playerUpgrades.hpBoost += 1;
      showWarning(`â¤ï¸ +${value}`);
      updateUI();
      updateStatsOverlay();
    }
  });
}

// ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n â€“ luÃ´n cÃ³ thá»ƒ nÃ¢ng
{
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].bulletSpeed;
  allUpgrades.push({
    name: "ğŸ’¨ Tá»‘c Ä‘á»™ Ä‘áº¡n",
    key: "bulletSpeed",
    tier,
    value,
    effect: () => {
      playerUpgrades.bulletSpeed += value;
      showWarning(`ğŸ’¨ +${value.toFixed(1)}`);
      updateStatsOverlay();
    }
  });
}

// ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n â€“ náº¿u chÆ°a max
if (playerUpgrades.lineBulletCount < MAX_LINE_BULLETS) {
  const tier = randomTier();
  const value = 1;
  allUpgrades.push({
    name: "ğŸ§¨ sá»‘ lÆ°á»£ng Ä‘áº¡n",
    key: "lineBulletCount",
    tier,
    value,
    effect: () => {
      playerUpgrades.lineBulletCount += value;
      showWarning(`ğŸ§¨ +${value} viÃªn má»—i hÃ ng`);
      updateStatsOverlay();
    }
  });
}

// ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y â€“ hiáº¿m vÃ  chá»‰ 1 cáº¥p (náº¿u chÆ°a max)
if (player.speed < MAX_MOVE_SPEED) {
  const value = UPGRADE_VALUES.Rare.moveSpeed;
  allUpgrades.push({
    name: "ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y",
    key: "moveSpeed",
    tier: "Rare",
    value,
    effect: () => {
      player.speed = Math.min(player.speed + value, MAX_MOVE_SPEED);
      showWarning(`ğŸ‘Ÿ +${value.toFixed(1)} tá»‘c Ä‘á»™`);
      updateStatsOverlay();
    }
  });
}


  // ğŸ² XÃ¡o trá»™n vÃ  chá»n ngáº«u nhiÃªn 3 nÃ¢ng cáº¥p
  const choices = allUpgrades.sort(() => Math.random() - 0.5).slice(0, 3);

  // ğŸ–±ï¸ Táº¡o nÃºt cho tá»«ng nÃ¢ng cáº¥p
  choices.forEach(up => {
    const btn = document.createElement("button");
    btn.innerText = up.name;
    btn.style.borderColor = TIER_COLORS[up.tier]; // viá»n theo báº­c
 btn.onclick = () => {
  up.effect(); // thá»±c thi nÃ¢ng cáº¥p
  popup.style.display = "none";
  isPaused = false;
  lastWaveTime = Date.now(); // â±ï¸ báº¯t Ä‘áº§u Ä‘áº¿m thá»i gian

  // â³ Chá» 500ms má»›i hiá»ƒn thá»‹ wave
  if (pendingWave !== null) {
    setTimeout(() => {
      showWavePopup();
      pendingWave = null;
    }, 500);
  }
};
    container.appendChild(btn);
  });

  popup.style.display = "block"; // hiá»ƒn thá»‹ popup
  isPaused = true; // â¸ï¸ Táº¡m dá»«ng game
  popup.style.display = "block";
}

// ğŸ² Chá»n báº­c nÃ¢ng cáº¥p ngáº«u nhiÃªn theo tá»· lá»‡
function randomTier() {
  const tiers = ["Báº¡c", "VÃ ng", "Kim"];
  const weights = [0.6, 0.3, 0.1]; // tá»· lá»‡ gáº·p: 60% Báº¡c, 30% VÃ ng, 10% Kim
  const r = Math.random();
  let sum = 0;
  for (let i = 0; i < tiers.length; i++) {
    sum += weights[i];
    if (r < sum) return tiers[i];
  }
  return "Báº¡c"; // fallback náº¿u cÃ³ lá»—i
}

function updateStatsOverlay() {
  document.getElementById("stat-damage").innerText = `ğŸ’¥ SÃ¡t thÆ°Æ¡ng: ${playerUpgrades.damageBoost}`;
  document.getElementById("stat-spawned").innerText = `ğŸ§Ÿ Tá»•ng sá»‘ zombie: ${zombieSpawnedCount}`;
  document.getElementById("stat-alive").innerText = `ğŸ§Ÿ Äang cÃ²n sá»‘ng: ${zombies.length}`;
  document.getElementById("stat-total").innerText = `ğŸ§Ÿ ÄÃ£ tiÃªu diá»‡t: ${zombieKillCount}`;
  document.getElementById("stat-speed").innerText = `ğŸ’¨ Tá»‘c Ä‘á»™: ${playerUpgrades.bulletSpeed.toFixed(1)}`;
  document.getElementById("stat-fireRate").innerText = `ğŸ”« HÆ°á»›ng báº¯n: ${playerUpgrades.fireRate}`;
  document.getElementById("stat-lineCount").innerText = `ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n: ${playerUpgrades.lineBulletCount}`;
  document.getElementById("stat-moveSpeed").innerText = `ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y: ${player.speed.toFixed(1)}`;
const expectedTotal = zombieKillCount + zombies.length;
if (expectedTotal !== zombieSpawnedCount) {
}

  // Ká»¹ nÄƒng khÃ¡c
  const skillText = Object.entries(skillStats)
    .map(([key, value]) => `${key}: ${value}`)
    .join("<br>");
  document.getElementById("stat-skills").innerHTML = skillText;

  // ğŸ§Ÿ Zombie theo cáº¥p: chá»‰ hiá»ƒn thá»‹ tá»« Cáº¥p 1 â†’ 10
  let breakdown = "";
  for (let i = 1; i <= 10; i++) {
    breakdown += `<div>ğŸ§Ÿ Cáº¥p ${i}: ${zombieByLevel[i] || 0}</div>`;
  }

  // ğŸ’€ Thá»‘ng kÃª Mini Boss & Boss á»Ÿ cuá»‘i
  const miniBossLine = `<div>ğŸ’€ Mini Boss: ${zombieByLevel.miniBoss || 0}</div>`;
  const bossLine = `<div>ğŸ’€ Boss: ${zombieByLevel.boss || 0}</div>`;

  document.getElementById("stat-breakdown").innerHTML =
    breakdown + miniBossLine + bossLine;
}

// ğŸ¯ PhÃ­m Z Ä‘á»ƒ báº­t/táº¯t báº£ng thá»‘ng kÃª
document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "z") {
    const panel = document.getElementById("statsOverlay");
    panel.classList.toggle("hidden");
  }
});

</script>
<!-- ğŸŒŸ Popup khi lÃªn cáº¥p -->
<div id="levelUpPopup">Level Up!</div>
<!-- ğŸŒŸ Popup chá»n nÃ¢ng cáº¥p -->
<div id="upgradePopup">
  <h3 class="upgradeTitle">â« Chá»n nÃ¢ng cáº¥p</h3>
  <div id="upgradeChoices" class="upgradeChoices"></div>
</div>

<!-- ğŸ“Š Overlay hiá»ƒn thá»‹ thá»‘ng sá»‘ ká»¹ nÄƒng -->
<div id="statsOverlay">
  <h3>ğŸ“Š Thá»‘ng kÃª</h3>
  <div id="stat-moveSpeed">ğŸ‘Ÿ Tá»‘c Ä‘á»™ cháº¡y: - </div>
  <div id="stat-damage">ğŸ’¥ SÃ¡t thÆ°Æ¡ng: - </div>
  <div id="stat-fireRate">ğŸ”« HÆ°á»›ng báº¯n: - </div>
  <div id="stat-speed">ğŸ’¨ Tá»‘c Ä‘á»™: - </div>
  <div id="stat-lineCount">ğŸ§¨ Sá»‘ lÆ°á»£ng Ä‘áº¡n: - </div>
  <div id="stat-skills"></div> <!-- ká»¹ nÄƒng khÃ¡c -->
  <div id="stat-spawned">ğŸ§Ÿ Tá»•ng sá»‘ zombie: 0</div>
  <div id="stat-alive">ğŸ§Ÿ Äang cÃ²n sá»‘ng: 0</div>
  <div id="stat-total">ğŸ§Ÿ ÄÃ£ tiÃªu diá»‡t: 0</div>
  <div id="stat-breakdown">
    <!-- sáº½ Ä‘Æ°á»£c cáº­p nháº­t báº±ng JS -->
  </div>
</div>

</body>
</html>
