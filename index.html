<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Zombie Survivor - Dang</title>
<style>
  :root {
  /* 🎨 Màu sắc chính */
  --color-bg-dark: #111;
  --color-primary: #00ffff;
  --color-accent: gold;
  --color-danger: #ff4c4c;
  --color-text: #e0f7fa;
  --color-hover-bg: #22404c;
  --color-hover-border: #3d6c78;
  --color-title: #aefeff;
  --glow-title: 0 0 6px #7f7fff, 0 0 12px #4d4dfb;

  /* 🔘 Màu button riêng */
  --btn-bg: #1a2b33;
  --btn-border: #294e5a;

  /* 🔤 Kích thước font chữ */
  --font-xs: 0.75rem;
  --font-sm: 0.9rem;
  --font-md: 1rem;
  --font-lg: 1.25rem;
  --font-xl: 1.5rem;
  --font-xxl: 2.5rem;

  /* 📏 Kích thước padding/margin chuẩn */
  --space-xs: 0.4rem;
  --space-sm: 0.6rem;
  --space-md: 1rem;
  --space-lg: 1.5rem;
  --space-xl: 2rem;

  /* 🌟 Độ sáng bóng / hiệu ứng */
  --glow-primary: 0 0 8px var(--color-primary);
  --glow-accent: 0 0 8px var(--color-accent);
}

  body { margin: 0; background: #111; overflow: hidden; font-family: sans-serif; }
  canvas { display: block; margin: auto; background: radial-gradient(#333, #000); transition: background 1s ease; }
/* 🎯 Giao diện chính */
#ui {
  position: absolute;
  top: 0vh; /* cách top theo chiều cao màn hình */
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 0.2rem; /* khoảng cách giữa các nút */
  padding: 0.7rem 1.5rem; 
  background: rgb(0, 0, 0); /* nền trong suốt */
  border-radius: 0rem;
  width: 90%; /* tỷ lệ theo chiều ngang */
  max-width: 57rem; /* giới hạn tối đa */
  justify-content: center;
  z-index: 1000;
  flex-wrap: wrap;
}

/* 🔘 Nút trong UI (nhỏ gọn hơn nút mặc định) */
#ui button {
  padding: 0.6rem 0.6rem;
  font-size: 0.75rem;
  min-width: 6.5rem;
}

/* 🔘 Nút mặc định cho toàn giao diện */
button {
  font-family: 'Segoe UI', sans-serif;
  padding: 0.65rem 1.25rem;
  font-size: 1rem;
  cursor: pointer;
  min-width: 6.5rem;
  text-align: center;
  background-color: #1a2b33;
  border: 0.125rem solid #294e5a;
  border-radius: 0.5rem;
  color: #e0f7fa;
  transition: all 0.2s ease;
  box-shadow: 0 0.125rem 0.3rem rgba(0, 0, 0, 0.2);
}

/* 🔁 Hiệu ứng hover cho nút */
button:hover {
  background-color: #22404c;
  border-color: #3d6c78;
  color: #ffffff;
  transform: translateY(-0.06rem);
}

/* 🖱 Hiệu ứng khi click giữ */
button:active {
  transform: scale(0.97);
  box-shadow: 0 0.06rem 0.2rem rgba(0, 0, 0, 0.3);
}

/* ✳️ Nút đang active (được chọn) */
button.active {
  border-color: #00ffff;
  box-shadow: 0 0 0.625rem #00ffffaa;
}

/* ✅ Trạng thái active dùng cho nhiều thành phần */
.active {
  outline: 0.125rem solid gold;
  border-radius: 0.5rem;
}

/* 📊 Vùng hiển thị điểm số hoặc thông tin */
#score {
  display: flex;
  flex-direction: column;
  justify-content: center;
  align-items: center;
  min-width: 7.5rem;
  text-align: center;
  color: white;
  font-size: 1rem;
  padding: 0.3rem 0.6rem;
}

/* ℹ️ Tooltip container bao ngoài để hiển thị gợi ý */
.tooltip-container {
  position: relative;
  display: inline-block;
  margin: 0.4rem;
}

/* 📝 Tooltip nội dung khi hover */
.tooltip-container .tooltip-text {
  visibility: hidden;
  background-color: #222;
  color: #fff;
  text-align: left;
  border-radius: 0.375rem;
  padding: 0.5rem 0.6rem;
  position: absolute;
  z-index: 10;
  top: 110%;
  left: 50%;
  transform: translateX(-50%);
  opacity: 0;
  width: 13.75rem;
  font-size: 0.8125rem;
  line-height: 1.5;
  white-space: pre-line;
  transition: opacity 0.3s ease;
  box-shadow: 0 0.125rem 0.5rem rgba(0, 0, 0, 0.5);
}

/* 🖱 Hiển thị tooltip khi hover vào container */
.tooltip-container:hover .tooltip-text {
  visibility: visible;
  opacity: 1;
}

/* 🔄 Nút restart đặc biệt */
#restartBtn {
  padding: 0.75rem 1.75rem;
  font-weight: bold;
  background-color: #1c2e36;
  border: 0.125rem solid #3a6b75;
  border-radius: 0.5rem;
  font-size: 1rem;
  color: #aefeff;
  cursor: pointer;
  transition: 0.25s ease;
}

/* 🖱 Hover cho restart */
#restartBtn:hover {
  background-color: #28515f;
  color: white;
  transform: translateY(-0.06rem);
}

/* ⏳ Hiển thị đồng hồ đếm wave */
#waveTimerDisplay {
  position: fixed;
  top: 12vh;
  left: 50%;
  transform: translateX(-50%);
  font-size: 1.2rem;
  color: gold;
  z-index: 10;
  text-shadow: 0 0 8px gold;
  font-weight: bold;
  font-family: 'Courier New', monospace;
  letter-spacing: 0.1rem;
  pointer-events: none;
}

/* 🌊 Popup khi bắt đầu Wave */
#wavePopup {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%) scale(1);
  font-size: 2.5rem;
  color: var(--color-primary);
  font-weight: bold;
  text-shadow:
    0 0 8px var(--color-accent),
    0 0 20px var(--color-accent);
  display: none;
  z-index: 999;
  opacity: 0;
  animation: waveFade 1s ease-out forwards;
}

/* ✨ Animation xuất hiện mềm mượt */
@keyframes waveFade {
  0% {
    opacity: 0;
    transform: translate(-50%, -50%) scale(0.7);
  }
  50% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1.05);
  }
  100% {
    opacity: 1;
    transform: translate(-50%, -50%) scale(1);
  }
}

/* 📋 Menu bắt đầu game */
#startMenu {
  max-width: 24rem;
  width: 90%;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  color: white;
  padding: 2rem;
  text-align: center;
  border-radius: 1rem;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 9999;
}

/* 🌟 Popup khi lên cấp */
#levelUpPopup {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.5rem;
  color: gold;
  font-weight: bold;
  text-shadow: 0 0 15px #ffff00;
  display: none;
  z-index: 2000;
}

/* 💀 Panel Game Over hiển thị khi thua */
.gameOverPanel {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: #22222200;
  padding: 30px;
  color: white;
  display: none;
  flex-direction: column;
  align-items: center;
  border-radius: 10px;
  background: rgba(0, 0, 0, 0.5);
  backdrop-filter: blur(6px);
  border: 1px solid rgba(255, 255, 255, 0.1);
  z-index: 2000;
}

/* 🎯 Tiêu đề Game Over */
.gameOverTitle {
  color: #ff5722;
  font-size: 2.5rem;
  text-shadow: 0 0 4px #ffff00, 0 0 4px #ffff00;
  margin-bottom: 1rem;
}

/* 🔁 Nút Chơi lại trong Game Over Panel */
.restartButton {
  margin-top: 10px;
  padding: 10px 20px;
  background-color: #1c2e36;
  border: 0.125rem solid #3a6b75;
  border-radius: 0.5rem;
  font-size: 1rem;
  color: #aefeff;
  cursor: pointer;
  transition: 0.25s ease;
}

.restartButton:hover {
  background-color: #28515f;
  color: white;
  transform: translateY(-0.06rem);
}

/* 🧠 Tiêu đề game ở menu bắt đầu */
.gameTitle {
  font-size: 2.5rem;
  font-weight: 900;
  color: var(--color-title);
  text-shadow: var(--glow-title);
  margin-bottom: 1.5rem;
  font-family: 'Segoe UI', sans-serif;
}

/* ⚠️ Popup cảnh báo (dùng cho showWarning) */
.warningPopup {
  position: fixed;
  top: 20%;
  left: 50%;
  transform: translateX(-50%);
  background: rgba(0, 32, 64, 0.9);
  color: var(--color-text);
  padding: var(--space-sm) var(--space-lg);
  border-radius: 0.75rem;
  font-size: var(--font-md);
  font-weight: 500;
  z-index: 9999;
  box-shadow: 0 0 10px #00bcd4aa;
  font-family: 'Segoe UI', sans-serif;
  pointer-events: none;
}

/* 🌟 Giao diện popup nâng cấp */
#upgradePopup {
  display: none;
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  background: rgba(0, 0, 0, 0.85);
  border: 2px solid gold;
  padding: 2rem;
  border-radius: 1rem;
  z-index: 9999;
  max-width: 36rem;
  width: 90%;
  text-align: center;
  box-shadow: 0 0 15px gold;
}

.upgradeTitle {
  color: gold;
  font-size: 1.8rem;
  font-weight: bold;
  margin-bottom: 1.5rem;
  text-shadow: 0 0 6px gold;
  margin-top: 1rem;
}

.upgradeChoices {
  display: flex;
  justify-content: center;
  gap: 1rem;
  flex-wrap: nowrap; /* ❗ KHÔNG cho xuống dòng */
}

.upgradeChoices button {
  padding: 0.8rem 1.2rem;
  border: 2px solid #ccc;
  border-radius: 0.6rem;
  background: #111;
  color: white;
  font-size: 1rem;
  font-weight: bold;
  min-width: 8rem;
  cursor: pointer;
  transition: 0.2s ease;
}

.upgradeChoices button:hover {
  background: #22404c;
  border-color: gold;
  color: #fff;
  box-shadow: 0 0 10px gold;
}

/* 📊 Overlay thống kê */
#statsOverlay {
  position: fixed;
  top: 0.5rem;
  right: 0.5rem;
  background: rgba(0, 0, 0, 0.7);
  border: 2px solid #00ffff;
  border-radius: 1rem;
  padding: 1rem;
  color: #e0f7fa;
  font-size: 0.95rem;
  line-height: 1.5;
  z-index: 9999;
  width: 15rem;
  font-family: 'Segoe UI', sans-serif;
}

#statsOverlay h3 {
  font-size: 1.1rem;
  margin-top: 0;
  margin-bottom: 0.5rem;
  color: gold;
  text-align: center;
}

#statsOverlay.hidden {
  display: none;
}
/* kết thúc style */
</style>
</head>
<body>
<div id="ui">
<div class="tooltip-container">
  <button id="autoBtn">⚙️ Auto</button>
  <span class="tooltip-text">⚙️ Auto:
    - Tự động tấn công zombie gần nhất
    - Tiêu hao: 0 ⚡
  </span>
</div>

<div class="tooltip-container">
  <button id="bladeBtn">🔪 Đao</button>
  <span class="tooltip-text">🔪 Kỹ năng Đao:
    - Tạo 20 thanh đao xoay quanh
    - Bay vào zombie gần nhất
    - Yêu cầu level 1
    - Sát thương: 1 
    - Hiệu lực: 30s ⏱
    - Tiêu hao: 3 ⚡
  </span>
</div>

<div class="tooltip-container">
  <button id="swordBtn">⚔️ Kiếm</button>
  <span class="tooltip-text">⚔️ Kỹ năng Kiếm:
    - Tạo mưa kiếm rơi từng đợt
    - Bay vào zombie gần nhất
    - Yêu cầu level 3
    - Sát thương: 1
    - Hiệu lực: 30s ⏱
    - Tiêu hao: 6 ⚡
  </span>
</div>

<div class="tooltip-container">
  <button id="fireBtn">🔥 Lửa</button>
  <span class="tooltip-text">🔥 Kỹ năng Lửa:
    - Tạo 2 quả cầu lửa quay quanh
    - Tiêu diệt zombie chạm vào
    - Yêu cầu level 5
    - Sát thương: 1
    - Hiệu lực: 45s ⏱
    - Tiêu hao: 8 ⚡
  </span>
</div>

<div class="tooltip-container">
  <button id="iceBtn">❄️ Băng</button>
  <span class="tooltip-text">❄️ Kỹ năng Băng (mở khóa Lv10):
    - Tạo 4 quả cầu băng lớn xoay quanh
    - Gây sát thương diện rộng
    - Yêu cầu level 10
    - Sát thương: 1
    - Hiệu lực: 60s ⏱
    - Tiêu hao: 12 ⚡
  </span>
</div>

<div id="score">
<div id="score-top">Điểm: 0 | Kỷ lục: 0 | ❤️: 3</div>
  <div id="score-bottom">Lv: 1 | ⚡: 0</div>
</div>  </div>
<canvas id="game" width="960" height="720"></canvas>

<!-- 📋 Menu bắt đầu game -->
<div id="startMenu">
  <h2 class="gameTitle">Zombie Survivor</h2>
  <button onclick="startGame()">Bắt đầu</button>
</div>

<!-- 💀 Game Over Panel -->
<div id="gameOverPanel" class="gameOverPanel" style="display: none;">
  <h2 class="gameOverTitle">Game Over</h2>
  <button onclick="location.reload()" class="restartButton">Chơi lại</button>
</div>

<!-- 🌊 Popup khi bắt đầu mỗi Wave -->
<div id="wavePopup">Wave 1</div>

<!-- ⏳ Đồng hồ đếm thời gian wave -->
<div id="waveTimerDisplay">--:--:--</div>

<script>
// 🧱 1. Biến toàn cục – Cấu hình & Khởi tạo

// 🔫 Cấu hình bắn
let shootCooldown = 1000;        // ⏱ Delay giữa mỗi đợt bắn
let lastShootBatchTime = 0;      // ⏱ Mốc thời gian đợt bắn
let currentBurstShots = 0;       // 💥 Số viên đã bắn trong đợt
let lastShootTime = 0;           // 🕒 Thời điểm bắn gần nhất
let autoBurstIndex = 0;
let autoLastBurstTime = 0;
const autoBurstDelay = 100; // ms delay giữa từng viên trong auto

// 🧠 Thống kê – Kỹ năng & zombie
let zombieKillCount = 0;
let zombieSpawnedCount = 0;
let zombieByLevel = {};
for (let i = 1; i <= 10; i++) zombieByLevel[i] = 0;
zombieByLevel.boss = 0;
zombieByLevel.miniBoss = 0;
let skillStats = {};             // 📊 Thống kê kỹ năng

// 🧍 Trạng thái người chơi
const player = {
  x: 400, y: 300, size: 20, speed: 1,
  hearts: 3, energy: 1, level: 1, score: 0,
  hitTimer: 0
};

// 🌟 Trạng thái nâng cấp
const playerUpgrades = {
  fireRate: 1,          // 🔫 Hướng bắn
  damageBoost: 1,       // 💥 Sát thương cộng thêm
  hpBoost: 0,           // ❤️ Số lần đã tăng máu
  bulletSpeed: 1,       // 💨 Tốc độ đạn
  lineBulletCount: 1    // 🧨 Số lượng đạn
};

// ⚙️ Trạng thái điều khiển & kỹ năng
let lastManualShootTime = 0;
const manualShootCooldown = 1000; // delay 1 giây
let lastAutoShootTime = 0;
const autoShootCooldown = 1000;

let keys = {}, autoShoot = false;
let fireActive = false, iceActive = false;
let swordActive = false, bladeActive = false;
let frame = 0, gameOver = false;
let isPaused = false;
let pendingWave = null;

let nextFireIndex = 0; // Kỹ năng đao xoay
// 🌊 Quản lý wave
let wave = 1;
let waveTime = 300; // Thời gian mỗi wave
let waveTimer = waveTime;
let lastWaveTime = null;
let gameStarted = false;

// ⏱ Thời gian kỹ năng
let fireTimer = 0, fireEndTime = 0;
let iceTimer = 0, iceEndTime = 0;
let swordTimer = 0, swordEndTime = 0;
let bladeTimer = 0, bladeEndTime = 0;
let levelUpGlowTime = 0;

// 📱 Điều khiển cảm ứng
let touchStartX = null, touchStartY = null;
let touchMoveX = null, touchMoveY = null;

// 🎮 Danh sách các đối tượng trong game
let enemyBullets = []; // Zombie bắn trả
let zombies = [];
let bullets = [];
let swords = [];
let downwardSwords = [];
let fireballs = [];
let iceballs = [];
let items = [];
let explosions = [];

// 🔧 Canvas
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// 🌀 Object Pooling
const bulletPool = [];
const explosionPool = [];
const zombiePool = [];
const swordPool = [];
const fireballPool = [];
const iceballPool = [];

//📲 2. Sự kiện điều khiển bàn phím, chuột, cảm ứng
// ⌨️ Bàn phím di chuyển
document.addEventListener("keydown", e => keys[e.key.toLowerCase()] = true);
document.addEventListener("keyup", e => keys[e.key.toLowerCase()] = false);

// 🖱 Click chuột để bắn
canvas.addEventListener("click", () => {
  const now = Date.now();
  if (now - lastManualShootTime >= manualShootCooldown) {
    shoot();
    lastManualShootTime = now;
  }
});

document.addEventListener("keydown", e => {
  if (e.code === 'Space') shoot();
});

// 📱 Điều khiển cảm ứng
canvas.addEventListener("touchstart", e => {
  const touch = e.touches[0];
  touchStartX = touch.clientX;
  touchStartY = touch.clientY;
});
canvas.addEventListener("touchmove", e => {
  const touch = e.touches[0];
  touchMoveX = touch.clientX;
  touchMoveY = touch.clientY;
  e.preventDefault(); // ngăn cuộn trang
});
canvas.addEventListener("touchend", () => {
  touchStartX = null;
  touchStartY = null;
  touchMoveX = null;
  touchMoveY = null;
});

//💥 3. Hàm hỗ trợ tiện ích
function distance(a, b) {
return Math.hypot(a.x - b.x, a.y - b.y);}

function dropItem(x, y, isBoss = false) {
  const dropRate = isBoss ? 0.3 : 0.05; // 🧟 Boss 30%, thường 5% rơi vật phẩm
  if (Math.random() < dropRate) {
    // 📦 Rơi lệch nhẹ quanh vị trí zombie
    const offsetX = (Math.random() - 0.5) * 30;
    const offsetY = (Math.random() - 0.5) * 30;

    const safeX = Math.min(canvas.width - 20, Math.max(20, x + offsetX));
    const safeY = Math.min(canvas.height - 20, Math.max(20, y + offsetY));

    items.push({ x: safeX, y: safeY, active: true });
  }
}

// 🔁 Bullet Pooling
function getBullet() {
  return bulletPool.length ? bulletPool.pop() : { x: 0, y: 0, dx: 0, dy: 0, active: true };
}
function releaseBullet(bullet) {
  bullet.active = false;
  bulletPool.push(bullet);
}

// 💥 Explosion Pooling
function getExplosion(x, y) {
  const e = explosionPool.length ? explosionPool.pop() : { x: 0, y: 0, radius: 0, life: 0, active: true };
  e.x = x;
  e.y = y;
  e.radius = 0;
  e.life = 20;
  e.active = true;
  return e;
}
function releaseExplosion(e) {
  e.active = false;
  explosionPool.push(e);
}

// 🧟 Zombie Pooling
function getZombie() {
  let z = zombiePool.length ? zombiePool.pop() : {
    x: 0, y: 0, radius: 15, canHit: true, speed: 1,
    color: "hotpink", isBoss: false, hp: 1, active: true
  };

  z.active = true;
  z._killed = false; // ✅ reset lại khi spawn
  return z;
}

function releaseZombie(z) {
  z.active = false;
  zombiePool.push(z);
}
// 💥 Hàm tiêu diệt zombie, dùng chung cho mọi kỹ năng
function killZombie(z) {
  if (z._killed || !z.active) return;
  z._killed = true;

  // 🧟 Gỡ khỏi màn và cộng thống kê
  releaseZombie(z);
  zombieKillCount++;

  // 🎯 Cộng điểm khi tiêu diệt
  player.score++;

  // 📊 Đếm theo cấp (level 1-10)
  if (z.level && z.level >= 1 && z.level <= 10) {
    zombieByLevel[z.level] = (zombieByLevel[z.level] || 0) + 1;
  }

  // 💀 Đếm miniBoss nếu là loại đó
  if (z.type === "miniBoss") {
    zombieByLevel.miniBoss = (zombieByLevel.miniBoss || 0) + 1;
  }

  // 💀 Đếm boss nếu là boss chính
  if (z.isBoss) {
    zombieByLevel.boss = (zombieByLevel.boss || 0) + 1;
  }

  // 🎁 Rơi vật phẩm tại vị trí zombie
  dropItem(z.x, z.y, z.isBoss);
}

// 🔪 Sword Pooling
function getSword() {
  return swordPool.length ? swordPool.pop() : {
    angle: 0,
    radius: 60,
    state: 'charging',
    chargeFrame: 90,
    x: 0,
    y: 0,
    target: null,
    fireDelay: 0,
    delay: 60
  };
}

function releaseSword(s) {
  swordPool.push(s);
}

// 🔥 Fireball Pooling
function getFireball() {
  return fireballPool.length ? fireballPool.pop() : {
    angle: 0,
    radius: 40,
    x: 0,
    y: 0
  };
}

function releaseFireball(f) {
  fireballPool.push(f);
}

// ❄️ Iceball Pooling
function getIceball() {
  return iceballPool.length ? iceballPool.pop() : {
    angle: 0,
    radius: 60,
    x: 0,
    y: 0
  };
}

function releaseIceball(i) {
  iceballPool.push(i);
}

function showWarning(message) {
  const popup = document.createElement("div");
  popup.innerText = message;
  popup.className = "warningPopup";
  document.body.appendChild(popup);
  setTimeout(() => popup.remove(), 1000);
}

function generateGradient(index) {
  const hue1 = (index * 137) % 360;
  const hue2 = (hue1 + 60) % 360;
  return `radial-gradient(circle at center, hsl(${hue1}, 70%, 50%), hsl(${hue2}, 40%, 20%))`;}

//🔫 4. Bắn đạn & auto shoot
function shoot() {
  const now = Date.now();
  if (now - lastManualShootTime < manualShootCooldown) return;
  lastManualShootTime = now;

  const directionCount = playerUpgrades.fireRate;
  const bulletsPerDirection = 1;
  const angleOffset = Math.random() * Math.PI * 2;
  const speed = playerUpgrades.bulletSpeed;

  for (let i = 0; i < directionCount; i++) {
    const angle = angleOffset + (2 * Math.PI / directionCount) * i;

    for (let j = 0; j < bulletsPerDirection; j++) {
      const b = getBullet();
      b.x = player.x;
      b.y = player.y;
      b.dx = Math.cos(angle);
      b.dy = Math.sin(angle);
      b.speed = speed;
      b.active = true;
      bullets.push(b);
    }
  }
}

function autoShootBurst() {
  const now = Date.now();
  if (now - lastAutoShootTime >= autoShootCooldown) {
    lastAutoShootTime = now;
    autoBurstIndex = 0;
  }

  const bulletsPerDirection = playerUpgrades.lineBulletCount;
  if (autoBurstIndex >= bulletsPerDirection) return;
  if (now - autoLastBurstTime < autoBurstDelay) return;
  if (zombies.length === 0) return;

  const target = zombies.reduce((a, b) =>
    distance(a, player) < distance(b, player) ? a : b
  );
  const angle = Math.atan2(target.y - player.y, target.x - player.x);

  const b = getBullet();
  b.x = player.x;
  b.y = player.y;
  b.dx = Math.cos(angle);
  b.dy = Math.sin(angle);
  b.speed = playerUpgrades.bulletSpeed;
  b.active = true;
  bullets.push(b);

  autoBurstIndex++;
  autoLastBurstTime = now;
}

//⚔️ 5. Kích hoạt kỹ năng (Kích hoạt kỹ năng & gán nút)
function activateSwordSkill() {
  if (!swordActive && player.energy >= 3) {
    swordActive = true;
    swordEndTime = Date.now() + 30000;
    swordTimer = 0;
    player.energy -= 3;
    document.getElementById("bladeBtn").classList.add("active");}}

function activateDownwardSwords() {
  if (!bladeActive && player.energy >= 6) {
    bladeActive = true;
    bladeEndTime = Date.now() + 30000;
    bladeTimer = 0;
    player.energy -= 6;
    document.getElementById("swordBtn").classList.add("active");}}

// 🖱 Gán sự kiện nút
document.getElementById("bladeBtn").onclick = () => {
  if (player.level < 1) return showWarning("🔪 Cần Lv1 để dùng Đao");
  activateSwordSkill();};

document.getElementById("swordBtn").onclick = () => {
  if (player.level < 3) return showWarning("⚔️ Cần Lv3 để dùng Kiếm");
  activateDownwardSwords();};

document.getElementById("fireBtn").onclick = () => {
  if (player.level < 5) {
    showWarning("🔥 Yêu cầu Lv5 - 8⚡");
    return;
  }
  if (!fireActive && player.energy >= 8) {
    fireActive = true;
    fireballs.length = 0;
const fireCount = 4; // Số lượng lửa
for (let i = 0; i < fireCount; i++) {
  const angle = (2 * Math.PI / fireCount) * i;
  const f = getFireball();
  f.angle = angle;
  f.radius = 40;
  f.x = player.x + Math.cos(angle) * 40;
  f.y = player.y + Math.sin(angle) * 40;
  fireballs.push(f);
}
    fireEndTime = Date.now() + 45000; // Thời gian kỹ năng
    player.energy -= 8;
    const btn = document.getElementById("fireBtn");
    btn.classList.add("active");
  }
};

document.getElementById("iceBtn").onclick = () => {
if (player.level < 10) return showWarning("❄️ Cần Lv10 để dùng Băng");
if (!iceActive && player.energy >= 12) {
    iceActive = true;
  iceballs.length = 0;
const iceCount = 6; // Số lượng băng
for (let i = 0; i < iceCount; i++) {
  const angle = (2 * Math.PI / iceCount) * i;
  const iBall = getIceball();
  iBall.angle = angle;
  iBall.radius = 60;
  iBall.x = player.x + Math.cos(angle) * 60;
  iBall.y = player.y + Math.sin(angle) * 60;
  iceballs.push(iBall);
}

    iceEndTime = Date.now() + 60000;
    player.energy -= 12;
    const btn = document.getElementById("iceBtn");
    btn.classList.add("active");
  }
};
document.getElementById("autoBtn").onclick = () => {
  autoShoot = !autoShoot;
  const btn = document.getElementById("autoBtn");
  if (autoShoot) {
    btn.classList.add("active");
  } else {
    btn.classList.remove("active");
  }
};

//🧟 6. Sinh zombie và boss
// 🎨 Màu tương ứng cho zombie cấp 1 → 10
const zombieColorsByLevel = [
  "#00cc66", // Level 1 – Xanh lá sáng (nhẹ nhàng)
  "#3399ff", // Level 2 – Xanh dương (nhạt hơn boss)
  "#ffcc00", // Level 3 – Vàng sáng
  "#ff9900", // Level 4 – Cam
  "#ff3333", // Level 5 – Đỏ sáng
  "#cc00cc", // Level 6 – Tím
  "#9933ff", // Level 7 – Tím xanh điện
  "#ff66cc", // Level 8 – Hồng neon
  "#00ffff", // Level 9 – Xanh cyan
  "#ffffff"  // Level 10 – Trắng sáng chói (gần max)
];

// 📊 Bảng xác suất cấp độ zombie theo từng wave
function getZombieLevelByWave(wave) {
  const levelTable = {
    1:  [100],
    2:  [70, 30],
    3:  [50, 50],
    4:  [40, 60],
    5:  [30, 70],
    6:  [20, 50, 30],
    7:  [15, 50, 35],
    8:  [10, 50, 40],
    9:  [5, 50, 45],
    10: [0, 50, 50],
    11: [20, 30, 20, 30],
    12: [15, 30, 25, 30],
    13: [10, 30, 30, 30],
    14: [5, 30, 35, 30],
    15: [0, 30, 40, 30],
    16: [0, 20, 40, 40],
    17: [0, 10, 40, 50],
    18: [0, 0, 40, 60],
    19: [0, 0, 30, 70],
    20: [0, 0, 20, 80],
    21: [0, 0, 10, 40, 50],
    22: [0, 0, 5, 35, 60],
    23: [0, 0, 5, 25, 60, 5],
    24: [0, 0, 0, 20, 50, 20, 10],
    25: [0, 0, 0, 15, 40, 25, 15, 5],
    26: [0, 0, 0, 10, 35, 25, 20, 10],
    27: [0, 0, 0, 5, 25, 25, 25, 15, 5],
    28: [0, 0, 0, 0, 20, 25, 25, 20, 10],
    29: [0, 0, 0, 0, 15, 20, 25, 25, 15],
    30: [0, 0, 0, 0, 10, 15, 25, 25, 20, 5]
  };

  // 👇 fallback khi wave > 30: zombie cấp 1–10
  const fallback = [1, 1, 10, 10, 15, 15, 15, 15, 10, 8];

  const table = levelTable[wave] || fallback;
  const rand = Math.random() * 100;
  let sum = 0;
  for (let i = 0; i < table.length; i++) {
    sum += table[i];
    if (rand < sum) return i;
  }
  return table.length - 1;
}

 function spawnZombie() {
  const z = getZombie();
  const level = getZombieLevelByWave(wave); // cấp từ 0–9
// HP zombie tăng theo level player + random 1~10
  if (wave >= 10) {
  z.hp = level + 1 + Math.floor(player.level / 2) + Math.floor(Math.random() * 10 + 1);
} else {
  z.hp = level + 1;
}
  z.level = level + 1; // cấp thật từ 1–10
  //z.speed = 0.01 + Math.random() * 0.2; // Tốc độ zombie
  // 👣 Di chuyển ngẫu nhiên ban đầu
z.state = "wandering";
z.nextStateCheck = Date.now() + 3000; // kiểm tra mỗi 3s khi đang chasing
z.wanderTime = Date.now() + 2000 + Math.random() * 2000; // từ 2 đến 4 giây
z.wanderAngle = Math.random() * Math.PI * 2;
// 🎲 Chọn kiểu wander: 80% di chuyển, 20% đứng im
z.wanderBehavior = Math.random() < 0.2 ? "pause" : "move";
z.baseSpeed = 0.02 + Math.random() * 0.3; // tốc độ khi chasing - tốc độ khi đuổi theo
z.speed = 0.015 + Math.random() * 0.05;   // tốc độ khi wandering - tốc độ khi lang thang
//Test1
  z.color = zombieColorsByLevel[level];
  z.type = "normal";
  z.radius = 15;
  z.isBoss = false;

// 🎯 Random mini boss (xuất hiện 1%) - Tỷ lệ xuất hiện mini boss
if (Math.random() < 0.01) {
  z.type = "miniBoss";
  z.hp = 50 + wave + Math.floor(player.level / 2) + Math.floor(Math.random() * 20 + 1); // HP mini boss tăng theo wave và level player
  z.color = "#ff3333";
  z.radius = 18;
  z.level = 99; // Đánh dấu riêng để không tính cấp thường
}

  // Tọa độ xuất hiện
  const side = Math.floor(Math.random() * 4);
  if (side === 0) { z.x = -40; z.y = Math.random() * canvas.height; }
  else if (side === 1) { z.x = canvas.width + 40; z.y = Math.random() * canvas.height; }
  else if (side === 2) { z.x = Math.random() * canvas.width; z.y = -40; }
  else { z.x = Math.random() * canvas.width; z.y = canvas.height + 40; }

  zombies.push(z);
  zombieSpawnedCount++;
}

// Màu boss
const bossColors = [
  "#ff3333", // Đỏ tươi
  "#ff8800", // Cam rực
  "#ffaa00", // Vàng cam
  "#00ccff", // Xanh dương sáng
  "#9933ff", // Tím đậm
  "#00ff99", // Xanh ngọc
  "#ff66cc", // Hồng neon
  "#ffffff", // Trắng lạnh
  "#888888", // Xám tro (boss máy móc)
  "#00ffff"  // Xanh cyan ánh kim
];

function spawnBoss() {
  const z = getZombie();

  const side = Math.floor(Math.random() * 4);
  if (side === 0) { z.x = -40; z.y = Math.random() * canvas.height; }
  else if (side === 1) { z.x = canvas.width + 40; z.y = Math.random() * canvas.height; }
  else if (side === 2) { z.x = Math.random() * canvas.width; z.y = -40; }
  else { z.x = Math.random() * canvas.width; z.y = canvas.height + 40; }

  z.radius = 30;
  z.canHit = true;
z.baseSpeed = 0.015 + Math.random() * 0.03; // Lưu tốc độ gốc | Tốc độ boss
z.speed = z.baseSpeed; // Bắt đầu bằng tốc độ gốc
  z.isBoss = true;
  // HP boss tăng theo wave và level player + random 1~100
  z.hp = 100 + wave * 2 + Math.floor(player.level / 2) + Math.floor(Math.random() * 100 + 1);
  z.type = "boss";
  z.level = 100; // level Boss
  z.color = bossColors[Math.floor(Math.random() * bossColors.length)]; // Màu boss
  z.active = true;

  zombies.push(z);
  zombieSpawnedCount++;
}

//🧠 7. Cập nhật UI – chỉ DOM
// 🧟 Hàm cập nhật Wave riêng biệt (dùng khi wave thay đổi)
function updateWaveUI() {
  document.getElementById("score-bottom").innerText =
    `Lv: ${player.level} | ⚡: ${player.energy} | Wave: ${wave}`;
}

let lastScore = -1, lastLevel = -1, lastEnergy = -1, lastHearts = -1, lastHighScore = -1;

function updateUI() {
  const highScore = Math.max(player.score, parseInt(localStorage.getItem('highScore') || '0'));
  if (player.score > highScore) {
    localStorage.setItem('highScore', player.score);
  }

  if (
    player.score !== lastScore ||
    player.hearts !== lastHearts ||
    highScore !== lastHighScore
  ) {
    lastScore = player.score;
    lastHearts = player.hearts;
    lastHighScore = highScore;
    document.getElementById("score-top").innerText =
      `Điểm: ${player.score} | Kỷ lục: ${highScore} | ❤️: ${player.hearts}`;
  }

  if (
    player.level !== lastLevel ||
    player.energy !== lastEnergy
  ) {
    lastLevel = player.level;
    lastEnergy = player.energy;
    updateWaveUI(); // 🧟 tách riêng hiển thị wave
  }
}

// 🧠 Hàm điều phối theo trạng thái sword
function updateSwordByState(s) {
  switch (s.state) {
    case 'charging': return updateSwordCharging(s);
    case 'readyToFire': return updateSwordReady(s);
    case 'flying': return updateSwordFlying(s);
    default: return true;
  }
}

// ⚙️ Đao đang xoay quanh người chơi trong trạng thái "charging"
function updateSwordCharging(s) {
  // Giảm thời gian xoay còn lại
  s.chargeFrame--;

  // Cập nhật góc quay & vị trí đao theo góc
  s.angle += 0.015;
  s.x = player.x + Math.cos(s.angle) * s.radius;
  s.y = player.y + Math.sin(s.angle) * s.radius;

  // Kiểm tra va chạm zombie gần đao
  checkSwordHitsNearbyZombie(s);

  // ✅ Khi xoay đủ thời gian → chuyển sang trạng thái "readyToFire"
  if (s.chargeFrame <= 0) {
    s.state = 'readyToFire';
    s.fireDelay = 30; // thời gian chờ trước khi bắt đầu bay
  }

  return true; // giữ đao trong mảng
}

// ⏳ Đao đang chờ sẵn để bay ra sau khi xoay xong
function updateSwordReady(s) {
  //  Mỗi đao chỉ bay khi đến lượt mình
  if (s.fireOrder === nextFireIndex) {
    s.fireDelay--;
    if (s.fireDelay <= 0) {
      s.state = 'flying';
      s.target = findActiveZombie();
      nextFireIndex++; // chuyển lượt sang đao tiếp theo
    }
  }

  return true;
}

// 🚀 Đao bay về phía mục tiêu (zombie)
function updateSwordFlying(s) {
  // Nếu không có target hoặc zombie đã chết → tìm lại zombie mới
  if (!s.target || !s.target.active) {
    s.target = findActiveZombie();
    if (!s.target) return true; // chưa có zombie → giữ đao chờ tiếp
  }

  // Di chuyển đao hướng tới mục tiêu
  moveSwordTowardsTarget(s);

  // Kiểm tra va chạm với mục tiêu
  if (distance(s, s.target) < 25) {
    handleSwordHit(s); // xử lý trúng địch
    return false;      // loại đao sau khi trúng
  }

  return true; // tiếp tục bay
}

// 📍 Di chuyển đao bay đến mục tiêu
function moveSwordTowardsTarget(s) {
  const dx = s.target.x - s.x;
  const dy = s.target.y - s.y;
  const angle = Math.atan2(dy, dx);
  s.x += Math.cos(angle) * 5;
  s.y += Math.sin(angle) * 5;
}

// 💥 Xử lý khi đao bay trúng mục tiêu
function handleSwordHit(s) {
  s.target.hp -= playerUpgrades.damageBoost || 1;
  if (!s.target._killed && s.target.hp <= 0) {
    killZombie(s.target);
  }
  explosions.push(getExplosion(s.target.x, s.target.y));
}

// 🧿 Tìm zombie còn sống gần player nhất
function findActiveZombie() {
  return zombies.find(z => z.active);
}

function checkSwordHitsNearbyZombie(s) {
  const target = zombies.find(z => z.active && distance(s, z) < 20);
  if (target) {
    target.hp -= playerUpgrades.damageBoost || 1;
    if (!target._killed && target.hp <= 0) killZombie(target);
    explosions.push(getExplosion(target.x, target.y));
  }
}

//🔄 8. Cập nhật logic game (Main loop logic)
function update() {
  if (!gameStarted || gameOver || isPaused) return; // 🛑 Dừng nếu đang pause
  // Cập nhật wave logic
  if (!gameStarted || gameOver) return; // 🚫 Nếu chưa bắt đầu hoặc đã Game Over thì dừng

  // ⏱ Đếm thời gian còn lại của wave
if (lastWaveTime) {
  const elapsed = (Date.now() - lastWaveTime) / 1000; // giây đã trôi qua
  const remaining = Math.max(0, waveTime - elapsed);  // thời gian còn lại
const min = Math.floor(remaining / 60);
const sec = Math.floor(remaining % 60);
const ms = Math.floor((remaining - Math.floor(remaining)) * 100); // lấy 2 chữ số sau dấu .
document.getElementById("waveTimerDisplay").innerText =
  `${min.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}:${ms.toString().padStart(2, '0')}`;

if (remaining <= 0) {
  wave++;
  pendingWave = wave;         // 🌊 lưu wave để hiển thị sau
  showUpgradePopup();         // 🎁 hiển thị nâng cấp trước
  lastWaveTime = Date.now();  // ⏱️ reset timer
  updateWaveUI();
}
}

// Xử lý kỹ năng Đao 🔪 tự tạo liên tục trong 30s
if (swordActive) {
  if (Date.now() >= swordEndTime) {
    swordActive = false;
    swords.length = 0;
    document.getElementById("bladeBtn").classList.remove("active");
    document.getElementById("bladeBtn").innerText = "🔪 Đao";
  } else {
    const remain = Math.ceil((swordEndTime - Date.now()) / 1000);
    document.getElementById("bladeBtn").innerText = `🔪 ${remain}s`;

    // Tạo thanh đao
if (swords.length === 0) {
  swordTimer = 0;
  const count = 8; // hoặc 12 tùy bạn muốn bao nhiêu đao
  nextFireIndex = 0;
for (let i = 0; i < count; i++) {
  const angle = (2 * Math.PI / count) * i;
  const s = getSword(); // hoặc tạo sword mới
  s.angle = angle;
  s.radius = 60;
  s.state = 'charging';
  s.chargeFrame = 90;
  s.fireDelay = 20 + i * 10; // từng đao delay khác nhau
  s.fireOrder = i; //  đánh số đao
  swords.push(s);
}
}
  }
}
// 🎯 Tối ưu xử lý trạng thái của swords
swords = swords.filter(updateSwordByState);

// === XỬ LÝ KỸ NĂNG KIẾM (từ trên cao) ===
 if (bladeActive) {
  if (Date.now() >= bladeEndTime) {
    bladeActive = false;
    downwardSwords.length = 0;
    document.getElementById("swordBtn").classList.remove("active");
    document.getElementById("swordBtn").innerText = "⚔️ Kiếm";
  } else {
    const remain = Math.ceil((bladeEndTime - Date.now()) / 1000);
    document.getElementById("swordBtn").innerText = `⚔️ ${remain}s`;

   // 🌧️ Tạo mưa kiếm mỗi 12 frame
if (frame % 12 === 0) {
  const count = Math.floor(Math.random() * 2) + 1; // chỉ 1–2 kiếm mỗi đợt
  for (let i = 0; i < count; i++) {
    const x = Math.random() * canvas.width;
    downwardSwords.push({
      x,
      y: -20,
      speed: 5 + Math.random() * 1.5 // rơi mượt
    });
  }
}
    // 🎯 Di chuyển và xử lý kiếm rơi
downwardSwords.forEach((s, si) => {
  s.y += s.speed;

  zombies.forEach((z) => {
    if (!z.active) return;
    if (distance(s, z) < 25) {
      z.hp -= playerUpgrades.damageBoost || 1;
      if (!z._killed && z.hp <= 0) killZombie(z);
      explosions.push(getExplosion(z.x, z.y));
    }
  });
});

// ❌ Xoá kiếm rơi quá màn hình
downwardSwords = downwardSwords.filter(s => s.y < canvas.height + 30);
  }
}

if (gameOver) return;

// 🔁 Giảm thời gian miễn sát thương
if (player.hitTimer > 0) {
  player.hitTimer--;
}

  // Player move
let moveX = 0;
let moveY = 0;

if (keys.w) moveY -= 1;
if (keys.s) moveY += 1;
if (keys.a) moveX -= 1;
if (keys.d) moveX += 1;

if (moveX !== 0 || moveY !== 0) {
  const length = Math.hypot(moveX, moveY);
  moveX /= length;
  moveY /= length;
  player.x += moveX * player.speed;
  player.y += moveY * player.speed;
}

// === Xử lý điều khiển cảm ứng ===
if (touchStartX !== null && touchMoveX !== null) {
  let dx = touchMoveX - touchStartX;
  let dy = touchMoveY - touchStartY;
  const len = Math.hypot(dx, dy);
  if (len > 10) { // chỉ di chuyển nếu vuốt đủ lớn
    dx /= len;
    dy /= len;
    player.x += dx * player.speed;
    player.y += dy * player.speed;
  }
}

if (autoShoot && player.level >= 1) autoShootBurst();

  // === Kỹ năng LỬA ===
  if (fireActive) {
    const remaining = Math.ceil((fireEndTime - Date.now()) / 1000);
    const fireBtn = document.getElementById("fireBtn");
    if (remaining > 0) {
      fireBtn.innerText = `🔥 ${remaining}s`;
    } else {
fireActive = false;
fireballs.forEach(f => releaseFireball(f));
fireballs.length = 0;
fireBtn.innerText = "🔥 Lửa";
fireBtn.classList.remove("active");
    }}

  // === Kỹ năng BĂNG ===
  if (iceActive) {
    const remaining = Math.ceil((iceEndTime - Date.now()) / 1000);
    const iceBtn = document.getElementById("iceBtn");
    if (remaining > 0) {
      iceBtn.innerText = `❄️ ${remaining}s`;
    } 
else {
iceActive = false;
iceballs.forEach(i => releaseIceball(i));
iceballs.length = 0;
iceBtn.innerText = "❄️ Băng";
iceBtn.classList.remove("active");
}}

updateBullets(); // gọi hàm đã viết sử dụng object pooling

  zombies.forEach((z, zi) => {
//    const angle = Math.atan2(player.y - z.y, player.x - z.x);
//z.x += Math.cos(angle) * z.speed;
//z.y += Math.sin(angle) * z.speed;
// 👣 Cập nhật hướng di chuyển theo trạng thái
// 🧠 AI hành vi zombie
if (z.state === "wandering") {
  if (Date.now() >= z.wanderTime) {
    z.state = "chasing";
    z.speed = z.baseSpeed;
    z.nextStateCheck = Date.now() + 3000;
  } else {
    // 👣 Di chuyển hoặc đứng yên
    if (z.wanderBehavior === "move") {
      z.x += Math.cos(z.wanderAngle) * z.speed;
      z.y += Math.sin(z.wanderAngle) * z.speed;
    }
    // Nếu pause thì không làm gì (đứng yên)
  }
} else if (z.state === "chasing") {
  if (Date.now() >= z.nextStateCheck) {
    z.nextStateCheck = Date.now() + 3000;

    // ❌ Boss không được chuyển sang wandering
    if (!z.isBoss && Math.random() < 0.05) {
      z.state = "wandering";
      z.wanderTime = Date.now() + 1500 + Math.random() * 8500; // Thời gian Zzz từ 1.5s - 10s
      z.wanderAngle = Math.random() * Math.PI * 2;
      z.speed = 0.15 + Math.random() * 0.05;
      z.wanderBehavior = Math.random() < 0.2 ? "pause" : "move"; // 20% đứng
      return;
    }
  }

  // 👊 Nếu vẫn chasing → đuổi theo player
  const angle = Math.atan2(player.y - z.y, player.x - z.x);
  z.x += Math.cos(angle) * z.speed;
  z.y += Math.sin(angle) * z.speed;
}
//Test2
// Zombie bắn trả
// 🧠 Boss hoặc mini boss bắn 1 lần mỗi 10 giây
if (z.isBoss || z.type === "miniBoss") {
  if (!z.lastShoot) z.lastShoot = 0;
  const now = Date.now();
if (now - z.lastShoot >= 10000) {
  z.lastShoot = now; // 
  if (Math.random() < 0.2) { // 💥 20% xác suất mỗi 10s
    const dx = player.x - z.x;
    const dy = player.y - z.y;
    const angle = Math.atan2(dy, dx);
    enemyBullets.push({
      x: z.x,
      y: z.y,
      dx: Math.cos(angle),
      dy: Math.sin(angle),
      speed: 0.8,
      hit: false
    });
  }
}
}
// 👾 Zombie thường chỉ bắn sau mỗi 15s và có 5% xác suất
if (!z.isBoss && z.type !== "miniBoss") {
  if (!z.lastShoot) z.lastShoot = 0;
  const now = Date.now();
  if (now - z.lastShoot >= 15000) {
    z.lastShoot = now;
    if (Math.random() < 0.05) {
      const dx = player.x - z.x;
      const dy = player.y - z.y;
      const angle = Math.atan2(dy, dx);
      enemyBullets.push({
        x: z.x,
        y: z.y,
        dx: Math.cos(angle),
        dy: Math.sin(angle),
        speed: 0.6 + Math.random() * 0.4,
        hit: false
      });
    }
  }
}

    if (distance(z, player) < z.radius + player.size) {
  if (z.canHit) {
    player.hearts--;
    explosions.push(getExplosion(z.x, z.y));
    z.canHit = false;

    // Cho phép zombie đánh lại sau 500ms
    setTimeout(() => { z.canHit = true; }, 500);

    if (player.hearts <= 0) {
      gameOver = true;
      document.getElementById("gameOverPanel").style.display = "flex";
    }
  }

  // đẩy zombie ra khỏi player
  const dx = z.x - player.x;
  const dy = z.y - player.y;
  const angle = Math.atan2(dy, dx);
  const pushBack = (z.radius + player.size - distance(z, player)) + 1;
  z.x += Math.cos(angle) * pushBack;
  z.y += Math.sin(angle) * pushBack;
}
  });

  // 🔥 Lửa
// 🔥 Cập nhật fireballs - kỹ năng lửa quay quanh player và gây sát thương
fireballs = fireballs.filter(f => {
  // Cập nhật vị trí fireball quay quanh player
  f.angle += 0.05;
  f.x = player.x + Math.cos(f.angle) * f.radius;
  f.y = player.y + Math.sin(f.angle) * f.radius;

  // Kiểm tra va chạm với zombie
  zombies.forEach(z => {
    if (!z.active) return;
    if (distance(f, z) < 25) {
      z.hp -= playerUpgrades.damageBoost || 1;
      if (z.hp <= 0) killZombie(z);
      explosions.push(getExplosion(z.x, z.y));
    }
  });

  // Giữ lại nếu kỹ năng vẫn đang hoạt động
  return fireActive;
});

// ❄️ Băng
// ❄️ Cập nhật iceballs - kỹ năng băng quay quanh player và gây sát thương
iceballs = iceballs.filter(f => {
  // Cập nhật vị trí iceball quay quanh player
  f.angle += 0.03;
  f.x = player.x + Math.cos(f.angle) * f.radius;
  f.y = player.y + Math.sin(f.angle) * f.radius;

  // Kiểm tra va chạm với zombie
  zombies.forEach(z => {
    if (!z.active) return;
    if (distance(f, z) < 25) {
      z.hp -= playerUpgrades.damageBoost || 1;
      if (z.hp <= 0) killZombie(z);
      explosions.push(getExplosion(z.x, z.y));
    }
  });

  // Giữ lại nếu kỹ năng vẫn đang hoạt động
  return iceActive;
});

  // Nhặt item ⚡
  items.forEach(it => {
  if (!it.active) return;
  if (distance(it, player) < 20) {
    player.energy += 1;
    it.active = false;
  }
});
items = items.filter(it => it.active);

const requiredScore = player.level * 10; // Tăng level #Tăng cấp
if (player.score >= requiredScore) {
  player.level++;
  player.hearts += 1 + (UPGRADE_TIERS.hpBoost[playerUpgrades.hpBoost] || 0);
  player.energy += 2; // 🎁 thưởng 2 năng lượng khi lên cấp

  // ✨ Đổi nền theo level
const levelBackgrounds = [
  "radial-gradient(circle at center, #2c3e50, #000000)",        // Lv1: Xanh đêm hiện đại
  "radial-gradient(circle at center, #4b79a1, #283e51)",         // Lv2: Xanh trời lạnh
  "radial-gradient(circle at center, #1e3c72, #2a5298)",         // Lv3: Biển sâu
  "radial-gradient(circle at center, #8e44ad, #2c3e50)",         // Lv4: Tím không gian
  "radial-gradient(circle at center, #e96443, #904e95)",         // Lv5: Cam tím mộng mơ
  "radial-gradient(circle at center, #ff512f, #dd2476)",         // Lv6: Nhiệt huyết
  "radial-gradient(circle at center, #00bf8f, #001510)",         // Lv7: Lục bảo ngọc
  "radial-gradient(circle at center, #2980b9, #6dd5fa)",         // Lv8: Mây xanh dịu
  "radial-gradient(circle at center, #f7971e, #ffd200)",         // Lv9: Nắng vàng
  "radial-gradient(circle at center, #1f4037, #99f2c8)",          // Lv10: Rừng mát
  "radial-gradient(circle at center, #ffffff33, #00ffff22, #000000)" // level 11+
];

let bg;
if (player.level <= 11) {
  bg = levelBackgrounds[player.level - 1];
} else {
  bg = generateGradient(player.level);
}
canvas.style.background = bg;

  // 🪄 Hiển thị popup level
  const popup = document.getElementById("levelUpPopup");
  popup.style.animation = "none"; // reset nếu đã có hiệu ứng trước đó
  void popup.offsetWidth;         // trigger reflow
  popup.style.display = "block";
  setTimeout(() => {
    popup.style.display = "none";
  }, 1200);
  levelUpGlowTime = 60; // ~1s sáng vàng

  // 🎯 Mỗi 2 cấp gọi boss
  if (player.level % 1 === 0) {
spawnBoss();
}}
  updateExplosions(); // dùng object pooling thay splice

if (levelUpGlowTime > 0) levelUpGlowTime--;

// 🎯 Cập nhật bullets – dùng object pooling thay vì splice
function updateBullets() {
  for (let i = 0; i < bullets.length; i++) {
    const b = bullets[i];
    if (!b.active) continue;

    // 🏃 Di chuyển đạn theo hướng và tốc độ lưu riêng
    b.x += b.dx * b.speed;
    b.y += b.dy * b.speed;

for (let j = 0; j < zombies.length; j++) {
  const z = zombies[j];
  if (!z.active) continue;

  if (distance(b, z) < 20) {
    if (z.hp > 0) {
      z.hp -= playerUpgrades.damageBoost || 1;
      if (z.hp <= 0) {
        killZombie(z);
      }
    }

    explosions.push(getExplosion(z.x, z.y));
    releaseBullet(b);
    break; // chỉ break sau khi đạn thực sự xử lý xong
  }
}
  }

  bullets = bullets.filter(b => b.active);
}

function updateEnemyBullets() {
  for (let i = 0; i < enemyBullets.length; i++) {
    const b = enemyBullets[i];
    b.x += b.dx * b.speed;
    b.y += b.dy * b.speed;

    // Nếu trúng người chơi
if (distance(b, player) < 15) {
  if (player.hitTimer === 0) {
    player.hearts--;
    player.hitTimer = 30;
    explosions.push(getExplosion(b.x, b.y));
    
    if (player.hearts <= 0) {
      gameOver = true;
      document.getElementById("gameOverPanel").style.display = "flex";
    }
  }
  b.hit = true;
}
  }

  // Loại bỏ đạn bay ra ngoài hoặc đã trúng
  enemyBullets = enemyBullets.filter(b => 
    !b.hit &&
    b.x >= -20 && b.x <= canvas.width + 20 &&
    b.y >= -20 && b.y <= canvas.height + 20
  );
}

// 💥 Cập nhật hiệu ứng nổ – thay thế splice bằng release
function updateExplosions() {
  explosions.forEach(e => {
    if (!e.active) return;
    e.radius += 2;
    e.life--;
    if (e.life <= 0) {
      releaseExplosion(e);
    }
  });
}

zombies = zombies.filter(z => z.active);

  updateUI();
  updateStatsOverlay();
  updateEnemyBullets();
}

//🎨 9. Vẽ khung hình (draw canvas)
function draw() {
  ctx.clearRect(0, 0, canvas.width, canvas.height);
  ctx.beginPath();
  ctx.arc(player.x, player.y, player.size, 0, Math.PI * 2);
if (levelUpGlowTime > 0) {
  ctx.shadowBlur = 8;
  ctx.shadowColor = "gold";
  ctx.fillStyle = "gold";
} else {
  ctx.shadowBlur = 0;
  ctx.shadowColor = "transparent"; // thêm dòng này để tắt sáng hẳn
  ctx.fillStyle = (player.hitTimer % 10 < 5) ? "#ff4c4c" : "#00ff00";
}
ctx.fill();
ctx.lineWidth = 2.2;
ctx.strokeStyle = "rgba(0, 255, 255, 0.4)"; // màu cyan nhạt
ctx.shadowColor = "rgba(0, 255, 255, 0.25)"; // phát sáng nhẹ
ctx.stroke();
  bullets.forEach(b => {
  if (!b.active) return; // 🛡 bỏ qua đạn đã bị gỡ
  ctx.beginPath();
  ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
  ctx.fillStyle = "yellow";
  ctx.fill();
});

// 🔫 Vẽ đạn từ boss & mini boss
enemyBullets.forEach(b => {
  ctx.beginPath();
  ctx.arc(b.x, b.y, 5, 0, Math.PI * 2);
  ctx.fillStyle = "red";
  ctx.fill();
});

zombies.forEach(z => {
    if (!z.active) return;
ctx.save();

// ✨ Hiệu ứng glow cho Boss & Mini Boss
if (z.isBoss || z.type === "miniBoss") {
  ctx.shadowColor = z.color || "#ffffff";
  ctx.shadowBlur = z.isBoss ? 10 : 5; // Boss sáng mạnh hơn
} else {
  ctx.shadowColor = "transparent";
  ctx.shadowBlur = 0;
}

ctx.beginPath();
ctx.arc(z.x, z.y, z.radius, 0, Math.PI * 2);
ctx.fillStyle = z.color || (z.isBoss ? "red" : "hotpink");
ctx.fill();

ctx.restore();

// 👇 Font dựa vào bán kính zombie để scale
ctx.font = `${z.radius * 1.5}px serif`;

// 👇 Căn giữa chuẩn cho icon
ctx.textAlign = "center";
ctx.textBaseline = "middle";

// 👇 Vẽ icon ngay giữa hình tròn
ctx.fillText(z.isBoss ? "💀" : "🧟", z.x, z.y);
//
// 💬 Icon trạng thái zombie nếu đang lang thang
if (!z.isBoss && z.state === "wandering") {
  ctx.save();
  ctx.font = `${z.radius * 1.2}px sans-serif`;
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
  ctx.fillStyle = "#fff";

  // Hiển thị icon tùy theo hành vi
  //const icon = z.wanderBehavior === "pause" ? "💤" : "😖";
  //ctx.fillText(icon, z.x + z.radius + 8, z.y + z.radius - 15);
  const icon = z.wanderBehavior === "pause" ? "💤" : "😖";
ctx.fillText(icon, z.x + z.radius + 8, z.y + z.radius - 15);
//Test5
  ctx.restore();
}
//Test3
// 🧠 Hiển thị HP còn lại trên đầu zombie thường
if (!z.isBoss) {
  ctx.save();
  ctx.fillStyle = z.color || "#fff";
  ctx.font = `${z.radius * 0.9}px monospace`;
  ctx.textAlign = "center";
  ctx.textBaseline = "bottom";
// 👇 Hiển thị cấp độ zombie = a–j (97 = 'a')
const levelChar = String.fromCharCode(96 + z.level);
const hpColor = z.color || "#fff";
const divider = "-" // 👈 hoặc " ", ".", "*"

ctx.save();
ctx.font = `${z.radius * 0.9}px 'Trebuchet MS', sans-serif`;
ctx.textAlign = "center";
ctx.textBaseline = "bottom";
ctx.fillStyle = hpColor;

// Hiển thị ví dụ: a-22 (cấp 1, HP 22)
ctx.fillText(`${levelChar}${divider}${z.hp}`, z.x, z.y - z.radius - 4);
ctx.restore();
}

  if (z.isBoss) {
ctx.save();
ctx.textAlign = "center";
ctx.textBaseline = "middle";
ctx.fillStyle = z.color || "#ffffff"; // 🎨 chữ cùng màu boss
ctx.font = `${z.radius * 0.03}rem sans-serif`; // tỉ lệ hợp lý hơn
ctx.fillText(`Boss: ${z.hp}`, z.x, z.y - z.radius - z.radius * 0.3);
ctx.restore();
}
});
// 🎯 Vẽ icon biểu cảm sau cùng để luôn nổi trên boss
zombies.forEach(z => {
  if (!z.iconToDraw) return;

  ctx.save();
  ctx.font = `${z.radius * 1.2}px serif`;
  ctx.textAlign = "left";
  ctx.textBaseline = "middle";
  ctx.fillStyle = "#fff";
  ctx.shadowColor = "#000";
  ctx.shadowBlur = 6;

  // giữ đúng vị trí bạn đặt: góc phải dưới
  ctx.fillText(z.iconToDraw, z.x + z.radius + 8, z.y + z.radius - 15);
  ctx.restore();
});

// Mắt và miệng xoay theo hướng zombie gần nhất
if (zombies.length > 0) {
  const target = zombies.reduce((a, b) => distance(a, player) < distance(b, player) ? a : b);
  const angle = Math.atan2(target.y - player.y, target.x - player.x);
  const eyeOffsetX = Math.cos(angle) * 6;
  const eyeOffsetY = Math.sin(angle) * 6;
  const mouthOffsetX = Math.cos(angle) * 10;
  const mouthOffsetY = Math.sin(angle) * 10;

  // Mắt trái
  ctx.beginPath();
  ctx.arc(player.x + eyeOffsetX - 4, player.y + eyeOffsetY - 4, 2, 0, Math.PI * 2);
  ctx.fillStyle = "white";
  ctx.fill();

  // Mắt phải
  ctx.beginPath();
  ctx.arc(player.x + eyeOffsetX + 4, player.y + eyeOffsetY - 4, 2, 0, Math.PI * 2);
  ctx.fill();

  // Miệng
  ctx.beginPath();
  ctx.arc(player.x + mouthOffsetX, player.y + mouthOffsetY + 3, 2, 0, Math.PI);
  ctx.strokeStyle = "white";
  ctx.lineWidth = 1;
  ctx.stroke();
}

explosions.forEach(e => {
  ctx.beginPath();
  ctx.arc(e.x, e.y, e.radius, 0, Math.PI * 2);
  ctx.fillStyle = `rgba(255, 200, 0, ${e.life / 20})`;
  ctx.fill();
});

drawItems();
drawEffects();

// 🎨 Vẽ vật phẩm energy ⚡
function drawItems() {
  items.forEach(it => {
    if (!it.active) return;
    ctx.save();
    ctx.font = "0.8rem serif"; // Kích thước vật phẩm
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.shadowBlur = 10;
    ctx.shadowColor = "gold";
    ctx.fillStyle = "gold";
    const bob = Math.sin(frame / 10 + it.x + it.y) * 2;
    ctx.fillText("⚡", it.x, it.y + bob);
    ctx.lineWidth = 1;
    ctx.strokeStyle = "#000";
    ctx.strokeText("⚡", it.x, it.y + bob);
    ctx.restore();
  });
}
}

// 🎨 Vẽ tất cả hiệu ứng kỹ năng gọn lại
function drawEffects() {
  fireballs.forEach(f => {
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.shadowBlur = 15;
    ctx.shadowColor = "orange";
    ctx.fillStyle = "orange";
    ctx.font = "1.3rem serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("🔥", 0, 0);
    ctx.restore();
  });

  iceballs.forEach(f => {
    ctx.save();
    ctx.translate(f.x, f.y);
    ctx.shadowBlur = 15;
    ctx.shadowColor = "#00e5ff";
    ctx.fillStyle = "#00e5ff";
    ctx.font = "1.3rem serif";
    // ctx.font = (f.radius * 0.9) + " serif"; Kỹ năng to ra khi lên level
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("❄️", 0, 0);
    ctx.restore();
  });

  swords.forEach(s => {
    ctx.save();
    ctx.translate(s.x, s.y);
    if (s.state === 'charging') {
  ctx.shadowBlur = 2; // Hiệu ứng bóng mờ
  ctx.shadowColor = '#00ffff';
  ctx.fillStyle = '#00ffff';
} else {
  ctx.shadowBlur = 0;
  ctx.fillStyle = 'white';
}
    ctx.font = "1.2rem serif";
    //ctx.font = (s.radius * 0.9) + " serif";
    ctx.textAlign = "center";
    ctx.textBaseline = "middle";
    ctx.fillText("🔪", 0, 0);
    ctx.restore();
  });

downwardSwords.forEach(s => {
  ctx.save();
  ctx.translate(s.x, s.y);
  ctx.shadowBlur = 15;
  ctx.shadowColor = '#00ffff';
  ctx.fillStyle = 'white';
  ctx.font = "1.2rem serif";
  ctx.textAlign = "center";
  ctx.textBaseline = "middle";
  ctx.fillText("⚔️", 0, 0);
  ctx.restore();
});
}

//🔁 10. Vòng lặp chính và khởi tạo game
function loop() {
update();
draw();
frame++;
if (frame % 120 === 0 && gameStarted) {
  if (zombies.length < 50) {
    const spawnCount = Math.min(1, 50 - zombies.length); // Giới hạn zombie
    for (let i = 0; i < spawnCount; i++) {
      spawnZombie();
    }
  }
}

requestAnimationFrame(loop);}

// ▶️ Khởi chạy ban đầu
spawnZombie();
loop();

//🧼 11. Các đoạn khởi tạo UI sau canvas
// Hàm bắt đầu game
function startGame() {
  document.getElementById("startMenu").style.display = "none";
  gameStarted = true;
  //Test
  // 🚀 Tăng nhanh để test wave 20+
  //wave = 11;
  //player.level = 11;
  //player.score = player.level * 10; // Đảm bảo đủ điểm để không bị tụt cấp
  //Test
  waveTimer = waveTime;
  showUpgradePopup();        // 🎁 Gọi nâng cấp trước
  pendingWave = wave;        // 🌊 Wave sẽ hiển thị sau khi nâng cấp xong
}

// 🌊 Hiện popup "Wave X bắt đầu"
function showWavePopup() {
  const popup = document.getElementById("wavePopup");
  popup.innerText = `Wave ${wave} bắt đầu!`;
  popup.style.animation = "none";
  void popup.offsetWidth; // force reflow để reset animation
  popup.style.display = "block";
  popup.style.animation = "waveFade 1s ease-out forwards";
  setTimeout(() => {
    popup.style.display = "none";
  }, 2000); // ẩn sau 2 giây
}

// 🎯 Giá trị theo cấp độ kỹ năng (mỗi cấp tăng dần)
const UPGRADE_TIERS = {
  fireRate: [1, 2, 3],
  damageBoost: [0.5, 1, 1.5],
  hpBoost: [2, 3, 5],            
  bulletSpeed: [0.25, 0.5, 1]
};

// 🌟 Hiển thị popup chọn nâng cấp kỹ năng
function showUpgradePopup() {
  const popup = document.getElementById("upgradePopup");
  const container = document.getElementById("upgradeChoices");
  container.innerHTML = "";

  // 📌 Bảng giá trị tương ứng với từng bậc nâng cấp
const UPGRADE_VALUES = {
  Bạc:  { fireRate: 1, damageBoost: 0.5, hpBoost: 2, bulletSpeed: 0.25 },
  Vàng: { fireRate: 2,  damageBoost: 1,   hpBoost: 3, bulletSpeed: 0.5 },
  Kim:  { fireRate: 3,    damageBoost: 1.5, hpBoost: 5, bulletSpeed: 1 },
  Rare: { moveSpeed: 0.2 } // 👟 tốc độ chạy – bậc hiếm
};
  // 🎖 Màu viền tương ứng từng bậc
const TIER_COLORS = {
  Bạc: "#aaa",
  Vàng: "gold",
  Kim: "#c770ff",
  Rare: "#3399ff" // 💚 màu xanh bậc hiếm
};

const MAX_FIRE_RATE = 21;
const MAX_LINE_BULLETS = 10;
const MAX_MOVE_SPEED = 3;

const allUpgrades = [];

// 🔫 Hướng bắn – nếu chưa max
if (playerUpgrades.fireRate < MAX_FIRE_RATE) {
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].fireRate;
  allUpgrades.push({
    name: "🔫 Hướng bắn",
    key: "fireRate",
    tier,
    value,
effect: () => {
  const added = Math.min(playerUpgrades.fireRate + value, MAX_FIRE_RATE) - playerUpgrades.fireRate;
  playerUpgrades.fireRate += added;
  showWarning(`🔫 +${added} hướng bắn`);
  updateStatsOverlay();
}
  });
}

// 💥 Sát thương – luôn có thể nâng
{
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].damageBoost;
  allUpgrades.push({
    name: "💥 Sát thương",
    key: "damageBoost",
    tier,
    value,
effect: () => {
  playerUpgrades.damageBoost += value;
  showWarning(`💥 +${value} sát thương`);
  updateStatsOverlay();
}
  });
}

// ❤️ Máu – luôn có thể nâng
{
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].hpBoost;
  allUpgrades.push({
    name: "❤️ Tăng máu",
    key: "hpBoost",
    tier,
    value,
    effect: () => {
      player.hearts += value;
      playerUpgrades.hpBoost += 1;
      showWarning(`❤️ +${value}`);
      updateUI();
      updateStatsOverlay();
    }
  });
}

// 💨 Tốc độ đạn – luôn có thể nâng
{
  const tier = randomTier();
  const value = UPGRADE_VALUES[tier].bulletSpeed;
  allUpgrades.push({
    name: "💨 Tốc độ đạn",
    key: "bulletSpeed",
    tier,
    value,
    effect: () => {
      playerUpgrades.bulletSpeed += value;
      showWarning(`💨 +${value.toFixed(1)}`);
      updateStatsOverlay();
    }
  });
}

// 🧨 Số lượng đạn – nếu chưa max
if (playerUpgrades.lineBulletCount < MAX_LINE_BULLETS) {
  const tier = randomTier();
  const value = 1;
  allUpgrades.push({
    name: "🧨 số lượng đạn",
    key: "lineBulletCount",
    tier,
    value,
    effect: () => {
      playerUpgrades.lineBulletCount += value;
      showWarning(`🧨 +${value} viên mỗi hàng`);
      updateStatsOverlay();
    }
  });
}

// 👟 Tốc độ chạy – hiếm và chỉ 1 cấp (nếu chưa max)
if (player.speed < MAX_MOVE_SPEED) {
  const value = UPGRADE_VALUES.Rare.moveSpeed;
  allUpgrades.push({
    name: "👟 Tốc độ chạy",
    key: "moveSpeed",
    tier: "Rare",
    value,
    effect: () => {
      player.speed = Math.min(player.speed + value, MAX_MOVE_SPEED);
      showWarning(`👟 +${value.toFixed(1)} tốc độ`);
      updateStatsOverlay();
    }
  });
}


  // 🎲 Xáo trộn và chọn ngẫu nhiên 3 nâng cấp
  const choices = allUpgrades.sort(() => Math.random() - 0.5).slice(0, 3);

  // 🖱️ Tạo nút cho từng nâng cấp
  choices.forEach(up => {
    const btn = document.createElement("button");
    btn.innerText = up.name;
    btn.style.borderColor = TIER_COLORS[up.tier]; // viền theo bậc
 btn.onclick = () => {
  up.effect(); // thực thi nâng cấp
  popup.style.display = "none";
  isPaused = false;
  lastWaveTime = Date.now(); // ⏱️ bắt đầu đếm thời gian

  // ⏳ Chờ 500ms mới hiển thị wave
  if (pendingWave !== null) {
    setTimeout(() => {
      showWavePopup();
      pendingWave = null;
    }, 500);
  }
};
    container.appendChild(btn);
  });

  popup.style.display = "block"; // hiển thị popup
  isPaused = true; // ⏸️ Tạm dừng game
  popup.style.display = "block";
}

// 🎲 Chọn bậc nâng cấp ngẫu nhiên theo tỷ lệ
function randomTier() {
  const tiers = ["Bạc", "Vàng", "Kim"];
  const weights = [0.6, 0.3, 0.1]; // tỷ lệ gặp: 60% Bạc, 30% Vàng, 10% Kim
  const r = Math.random();
  let sum = 0;
  for (let i = 0; i < tiers.length; i++) {
    sum += weights[i];
    if (r < sum) return tiers[i];
  }
  return "Bạc"; // fallback nếu có lỗi
}

function updateStatsOverlay() {
  document.getElementById("stat-damage").innerText = `💥 Sát thương: ${playerUpgrades.damageBoost}`;
  document.getElementById("stat-spawned").innerText = `🧟 Tổng số zombie: ${zombieSpawnedCount}`;
  document.getElementById("stat-alive").innerText = `🧟 Đang còn sống: ${zombies.length}`;
  document.getElementById("stat-total").innerText = `🧟 Đã tiêu diệt: ${zombieKillCount}`;
  document.getElementById("stat-speed").innerText = `💨 Tốc độ: ${playerUpgrades.bulletSpeed.toFixed(1)}`;
  document.getElementById("stat-fireRate").innerText = `🔫 Hướng bắn: ${playerUpgrades.fireRate}`;
  document.getElementById("stat-lineCount").innerText = `🧨 Số lượng đạn: ${playerUpgrades.lineBulletCount}`;
  document.getElementById("stat-moveSpeed").innerText = `👟 Tốc độ chạy: ${player.speed.toFixed(1)}`;
const expectedTotal = zombieKillCount + zombies.length;
if (expectedTotal !== zombieSpawnedCount) {
}

  // Kỹ năng khác
  const skillText = Object.entries(skillStats)
    .map(([key, value]) => `${key}: ${value}`)
    .join("<br>");
  document.getElementById("stat-skills").innerHTML = skillText;

  // 🧟 Zombie theo cấp: chỉ hiển thị từ Cấp 1 → 10
  let breakdown = "";
  for (let i = 1; i <= 10; i++) {
    breakdown += `<div>🧟 Cấp ${i}: ${zombieByLevel[i] || 0}</div>`;
  }

  // 💀 Thống kê Mini Boss & Boss ở cuối
  const miniBossLine = `<div>💀 Mini Boss: ${zombieByLevel.miniBoss || 0}</div>`;
  const bossLine = `<div>💀 Boss: ${zombieByLevel.boss || 0}</div>`;

  document.getElementById("stat-breakdown").innerHTML =
    breakdown + miniBossLine + bossLine;
}

// 🎯 Phím Z để bật/tắt bảng thống kê
document.addEventListener("keydown", (e) => {
  if (e.key.toLowerCase() === "z") {
    const panel = document.getElementById("statsOverlay");
    panel.classList.toggle("hidden");
  }
});

</script>
<!-- 🌟 Popup khi lên cấp -->
<div id="levelUpPopup">Level Up!</div>
<!-- 🌟 Popup chọn nâng cấp -->
<div id="upgradePopup">
  <h3 class="upgradeTitle">⏫ Chọn nâng cấp</h3>
  <div id="upgradeChoices" class="upgradeChoices"></div>
</div>

<!-- 📊 Overlay hiển thị thống số kỹ năng -->
<div id="statsOverlay">
  <h3>📊 Thống kê</h3>
  <div id="stat-moveSpeed">👟 Tốc độ chạy: - </div>
  <div id="stat-damage">💥 Sát thương: - </div>
  <div id="stat-fireRate">🔫 Hướng bắn: - </div>
  <div id="stat-speed">💨 Tốc độ: - </div>
  <div id="stat-lineCount">🧨 Số lượng đạn: - </div>
  <div id="stat-skills"></div> <!-- kỹ năng khác -->
  <div id="stat-spawned">🧟 Tổng số zombie: 0</div>
  <div id="stat-alive">🧟 Đang còn sống: 0</div>
  <div id="stat-total">🧟 Đã tiêu diệt: 0</div>
  <div id="stat-breakdown">
    <!-- sẽ được cập nhật bằng JS -->
  </div>
</div>

</body>
</html>
